<!DOCTYPE html>
<html lang="sv">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>FunktionÃ¤rsplanering</title>
    
    <!-- PWA / Add to Home Screen support -->
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="FunktionÃ¤rer">
    <meta name="application-name" content="FunktionÃ¤rer">
    <meta name="theme-color" content="#1a1a2e">
    <meta name="msapplication-navbutton-color" content="#1a1a2e">
    <meta name="msapplication-TileColor" content="#e85d04">
    
    <!-- App icon for home screen (using a data URI for self-contained file) -->
    <link rel="apple-touch-icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><rect fill='%231a1a2e' width='100' height='100' rx='20'/><rect fill='%23e85d04' x='10' y='85' width='80' height='5' rx='2'/><text x='50' y='65' font-size='45' text-anchor='middle' fill='white'>ðŸ“‹</text></svg>">
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><rect fill='%231a1a2e' width='100' height='100' rx='20'/><rect fill='%23e85d04' x='10' y='85' width='80' height='5' rx='2'/><text x='50' y='65' font-size='45' text-anchor='middle' fill='white'>ðŸ“‹</text></svg>">
    
    <link href="https://cdn.jsdelivr.net/npm/remixicon@4.2.0/fonts/remixicon.css" rel="stylesheet">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=DM+Sans:ital,opsz,wght@0,9..40,400;0,9..40,500;0,9..40,600;0,9..40,700;1,9..40,400&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary: #e85d04;
            --primary-dark: #d45203;
            --primary-light: #ff7b29;
            --secondary: #6b7280;
            --success: #059669;
            --success-light: #d1fae5;
            --warning: #d97706;
            --danger: #dc2626;
            --danger-light: #fee2e2;
            --bg: #faf7f5;
            --bg-warm: #f5f0eb;
            --card: #ffffff;
            --border: #e5e0db;
            --text: #1f1f1f;
            --text-muted: #6b7280;
            --charcoal: #1a1a2e;
            --charcoal-light: #2d2d44;
            --cream: #fdfcfa;
            --radius: 4px;
            --radius-lg: 8px;
            --shadow: 0 1px 3px rgba(26,26,46,0.08), 0 4px 12px rgba(26,26,46,0.04);
            --shadow-lg: 0 8px 30px rgba(26,26,46,0.12), 0 2px 8px rgba(26,26,46,0.06);
            --shadow-hover: 0 12px 40px rgba(26,26,46,0.16), 0 4px 12px rgba(26,26,46,0.08);
            --font-display: 'Bebas Neue', sans-serif;
            --font-body: 'DM Sans', -apple-system, BlinkMacSystemFont, sans-serif;
        }

        /* Noise texture overlay */
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            opacity: 0.03;
            z-index: 9999;
            background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 256 256' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noise'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.9' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noise)'/%3E%3C/svg%3E");
        }

        body {
            font-family: var(--font-body);
            background: var(--bg);
            color: var(--text);
            line-height: 1.6;
            font-size: 15px;
            -webkit-font-smoothing: antialiased;
        }

        /* Staggered load animation */
        @keyframes fadeSlideIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes scaleIn {
            from {
                opacity: 0;
                transform: scale(0.95);
            }
            to {
                opacity: 1;
                transform: scale(1);
            }
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 24px;
        }

        /* === HEADER === */
        header {
            background: var(--charcoal);
            color: white;
            padding: 0;
            margin-bottom: 32px;
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-lg);
            overflow: hidden;
            position: relative;
            animation: fadeSlideIn 0.6s ease-out;
        }

        /* Diagonal stripe pattern - sports field inspiration */
        header::before {
            content: '';
            position: absolute;
            top: 0;
            right: 0;
            width: 40%;
            height: 100%;
            background: repeating-linear-gradient(
                -45deg,
                transparent,
                transparent 8px,
                rgba(232, 93, 4, 0.15) 8px,
                rgba(232, 93, 4, 0.15) 16px
            );
            pointer-events: none;
        }

        header::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, var(--primary), var(--primary-light));
        }

        .header-content {
            padding: 28px 32px;
            position: relative;
            z-index: 1;
        }

        header h1 {
            font-family: var(--font-display);
            font-size: 2.5rem;
            font-weight: 400;
            letter-spacing: 2px;
            display: flex;
            align-items: center;
            gap: 16px;
            text-transform: uppercase;
        }

        header h1 i {
            color: var(--primary);
            font-size: 1.8rem;
        }

        header p {
            opacity: 0.7;
            margin-top: 4px;
            font-size: 0.95rem;
            letter-spacing: 0.5px;
        }

        .header-actions {
            display: flex;
            gap: 8px;
            margin-top: 16px;
        }

        .header-actions .btn {
            background: rgba(255,255,255,0.1);
            border: 1px solid rgba(255,255,255,0.2);
            color: white;
            backdrop-filter: blur(4px);
        }

        .header-actions .btn:hover {
            background: var(--primary);
            border-color: var(--primary);
        }

        /* === STATS GRID === */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 16px;
            margin-bottom: 32px;
            animation: fadeSlideIn 0.6s ease-out 0.1s backwards;
        }

        .stat-card {
            background: var(--card);
            border-radius: var(--radius-lg);
            padding: 20px 24px;
            box-shadow: var(--shadow);
            display: flex;
            align-items: center;
            gap: 16px;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            border: 1px solid var(--border);
            position: relative;
            overflow: hidden;
        }

        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 4px;
            height: 100%;
            background: var(--primary);
            transform: scaleY(0);
            transition: transform 0.3s ease;
        }

        .stat-card:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-hover);
        }

        .stat-card:hover::before {
            transform: scaleY(1);
        }

        .stat-card i {
            font-size: 1.5rem;
            color: var(--primary);
            opacity: 0.8;
        }

        .stat-card .value {
            font-family: var(--font-display);
            font-size: 2.5rem;
            font-weight: 400;
            color: var(--charcoal);
            line-height: 1;
            letter-spacing: 1px;
        }

        .stat-card .label {
            color: var(--text-muted);
            font-size: 0.8rem;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-top: 2px;
        }

        /* === TABS === */
        .tabs {
            display: flex;
            gap: 4px;
            margin-bottom: 32px;
            background: var(--card);
            padding: 6px;
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow);
            border: 1px solid var(--border);
            animation: fadeSlideIn 0.6s ease-out 0.2s backwards;
        }

        .tab-btn {
            padding: 14px 24px;
            border: none;
            background: transparent;
            color: var(--text-muted);
            border-radius: var(--radius);
            cursor: pointer;
            font-family: var(--font-body);
            font-size: 0.9rem;
            font-weight: 600;
            transition: all 0.25s ease;
            display: flex;
            align-items: center;
            gap: 10px;
            position: relative;
        }

        .tab-btn i {
            font-size: 1.1rem;
        }

        .tab-btn:hover {
            color: var(--text);
            background: var(--bg-warm);
        }

        .tab-btn.active {
            background: var(--charcoal);
            color: white;
            box-shadow: 0 2px 8px rgba(26,26,46,0.2);
        }

        .tab-btn.active i {
            color: var(--primary);
        }

        .tab-content {
            display: none;
            animation: scaleIn 0.4s ease-out;
        }

        .tab-content.active {
            display: block;
        }

        /* === CARDS === */
        .card {
            background: var(--card);
            border-radius: var(--radius-lg);
            padding: 28px;
            margin-bottom: 24px;
            box-shadow: var(--shadow);
            border: 1px solid var(--border);
            transition: all 0.3s ease;
        }

        .card:hover {
            box-shadow: var(--shadow-lg);
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
            padding-bottom: 16px;
            border-bottom: 2px solid var(--bg-warm);
        }

        .card-header h2 {
            font-family: var(--font-display);
            font-size: 1.75rem;
            font-weight: 400;
            letter-spacing: 1px;
            text-transform: uppercase;
            display: flex;
            align-items: center;
            gap: 12px;
            color: var(--charcoal);
        }

        .card-header h2 i {
            color: var(--primary);
            font-size: 1.3rem;
        }

        /* === BUTTONS === */
        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 50px;
            cursor: pointer;
            font-family: var(--font-body);
            font-size: 0.875rem;
            font-weight: 600;
            letter-spacing: 0.3px;
            transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1);
            display: inline-flex;
            align-items: center;
            gap: 8px;
            position: relative;
            overflow: hidden;
        }

        .btn::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            background: rgba(255,255,255,0.2);
            border-radius: 50%;
            transform: translate(-50%, -50%);
            transition: width 0.4s ease, height 0.4s ease;
        }

        .btn:active::before {
            width: 200px;
            height: 200px;
        }

        .btn-primary {
            background: var(--primary);
            color: white;
            box-shadow: 0 4px 14px rgba(232, 93, 4, 0.3);
        }

        .btn-primary:hover {
            background: var(--primary-dark);
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(232, 93, 4, 0.4);
        }

        .btn-secondary {
            background: var(--charcoal);
            color: white;
        }

        .btn-secondary:hover {
            background: var(--charcoal-light);
            transform: translateY(-2px);
        }

        .btn-success {
            background: var(--success);
            color: white;
            box-shadow: 0 4px 14px rgba(5, 150, 105, 0.3);
        }

        .btn-success:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(5, 150, 105, 0.4);
        }

        .btn-danger {
            background: var(--danger);
            color: white;
        }

        .btn-danger:hover {
            transform: translateY(-2px);
        }

        .btn-sm {
            padding: 8px 16px;
            font-size: 0.8rem;
            border-radius: 30px;
        }

        .btn-icon {
            width: 40px;
            height: 40px;
            padding: 0;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
        }

        /* === FORMS === */
        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--text);
            font-size: 0.875rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .form-control {
            width: 100%;
            padding: 14px 18px;
            border: 2px solid var(--border);
            border-radius: var(--radius);
            font-family: var(--font-body);
            font-size: 0.95rem;
            transition: all 0.25s ease;
            background: var(--cream);
        }

        .form-control:focus {
            outline: none;
            border-color: var(--primary);
            background: white;
            box-shadow: 0 0 0 4px rgba(232, 93, 4, 0.1);
        }

        .form-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
        }

        /* === TABLES === */
        table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
        }

        th, td {
            padding: 16px;
            text-align: left;
        }

        th {
            background: var(--charcoal);
            color: white;
            font-weight: 600;
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        th:first-child {
            border-radius: var(--radius) 0 0 0;
        }

        th:last-child {
            border-radius: 0 var(--radius) 0 0;
        }

        td {
            border-bottom: 1px solid var(--border);
            background: var(--card);
        }

        tr:last-child td {
            border-bottom: none;
        }

        tr:last-child td:first-child {
            border-radius: 0 0 0 var(--radius);
        }

        tr:last-child td:last-child {
            border-radius: 0 0 var(--radius) 0;
        }

        tbody tr {
            transition: all 0.2s ease;
        }

        tbody tr:hover td {
            background: var(--bg-warm);
        }

        /* === BADGES === */
        .badge {
            display: inline-flex;
            align-items: center;
            padding: 6px 14px;
            border-radius: 50px;
            font-size: 0.75rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .badge-primary {
            background: rgba(232, 93, 4, 0.1);
            color: var(--primary);
        }

        .badge-success {
            background: var(--success-light);
            color: var(--success);
        }

        .badge-warning {
            background: #fef3c7;
            color: var(--warning);
        }

        .badge-danger {
            background: var(--danger-light);
            color: var(--danger);
        }

        /* === MODALS === */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(26, 26, 46, 0.6);
            backdrop-filter: blur(4px);
            z-index: 1000;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .modal-overlay.active {
            display: flex;
            animation: fadeIn 0.2s ease-out;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .modal {
            background: var(--card);
            border-radius: var(--radius-lg);
            padding: 32px;
            max-width: 600px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 25px 60px rgba(26, 26, 46, 0.3);
            animation: modalSlideIn 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
            border: 1px solid var(--border);
        }

        @keyframes modalSlideIn {
            from {
                opacity: 0;
                transform: scale(0.9) translateY(20px);
            }
            to {
                opacity: 1;
                transform: scale(1) translateY(0);
            }
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
            padding-bottom: 16px;
            border-bottom: 2px solid var(--bg-warm);
        }

        .modal-header h3 {
            font-family: var(--font-display);
            font-size: 1.5rem;
            font-weight: 400;
            letter-spacing: 1px;
            text-transform: uppercase;
            color: var(--charcoal);
        }

        .close-btn {
            width: 40px;
            height: 40px;
            border: none;
            background: var(--bg-warm);
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.25rem;
            color: var(--text-muted);
            transition: all 0.2s ease;
        }

        .close-btn:hover {
            background: var(--danger);
            color: white;
            transform: rotate(90deg);
        }

        /* === CHIPS === */
        .member-chip {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            background: var(--bg-warm);
            padding: 8px 16px;
            border-radius: 50px;
            margin: 4px;
            font-size: 0.875rem;
            font-weight: 500;
            border: 1px solid var(--border);
            transition: all 0.2s ease;
        }

        .member-chip:hover {
            background: var(--bg);
            border-color: var(--primary);
        }

        .member-chip .remove {
            cursor: pointer;
            color: var(--danger);
            transition: transform 0.2s ease;
        }

        .member-chip .remove:hover {
            transform: scale(1.2);
        }

        /* === EVENT CARDS === */
        .event-card {
            border: 2px solid var(--border);
            border-radius: var(--radius-lg);
            padding: 24px;
            margin-bottom: 20px;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            background: var(--card);
            position: relative;
            overflow: hidden;
        }

        .event-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 4px;
            height: 100%;
            background: var(--primary);
            transform: scaleY(0);
            transition: transform 0.3s ease;
            transform-origin: top;
        }

        .event-card:hover {
            border-color: var(--primary);
            transform: translateX(4px);
            box-shadow: var(--shadow-lg);
        }

        .event-card:hover::before {
            transform: scaleY(1);
        }

        .event-card-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 16px;
        }

        .event-card-title {
            font-family: var(--font-display);
            font-size: 1.5rem;
            font-weight: 400;
            letter-spacing: 1px;
            text-transform: uppercase;
            color: var(--charcoal);
        }

        .event-card-date {
            color: var(--text-muted);
            font-size: 0.9rem;
            display: flex;
            align-items: center;
            gap: 8px;
            background: var(--bg-warm);
            padding: 6px 12px;
            border-radius: 50px;
        }

        .event-card-date i {
            color: var(--primary);
        }

        .shift-list {
            margin-top: 16px;
        }

        .shift-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 14px 18px;
            background: var(--bg-warm);
            border-radius: var(--radius);
            margin-bottom: 10px;
            border-left: 3px solid var(--primary);
            transition: all 0.2s ease;
        }

        .shift-item:hover {
            background: var(--bg);
            transform: translateX(4px);
        }

        .shift-info {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .shift-time {
            font-family: var(--font-display);
            font-size: 1.1rem;
            letter-spacing: 1px;
            color: var(--charcoal);
        }

        .shift-role {
            font-weight: 600;
            color: var(--text);
        }

        .shift-assigned {
            color: var(--text-muted);
            font-size: 0.875rem;
        }

        .person-schedule {
            margin-bottom: 28px;
            page-break-inside: avoid;
        }

        .person-schedule h3 {
            font-family: var(--font-display);
            font-size: 1.25rem;
            font-weight: 400;
            letter-spacing: 1px;
            margin-bottom: 16px;
            padding-bottom: 12px;
            border-bottom: 3px solid var(--primary);
            text-transform: uppercase;
        }

        .schedule-item {
            padding: 16px;
            background: var(--bg-warm);
            border-radius: var(--radius);
            margin-bottom: 10px;
            border-left: 3px solid var(--primary);
        }

        .schedule-event {
            font-weight: 700;
            color: var(--charcoal);
        }

        .schedule-details {
            color: var(--text-muted);
            font-size: 0.875rem;
            margin-top: 4px;
        }

        .message-preview {
            background: var(--charcoal);
            color: white;
            border-radius: var(--radius-lg);
            padding: 24px;
            margin-bottom: 20px;
            white-space: pre-wrap;
            font-family: 'SF Mono', 'Fira Code', monospace;
            font-size: 0.85rem;
            line-height: 1.7;
            position: relative;
            overflow: hidden;
        }

        .message-preview::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 4px;
            background: linear-gradient(90deg, var(--primary), var(--primary-light));
        }

        .message-preview h4 {
            font-family: var(--font-body);
            font-size: 0.8rem;
            font-weight: 700;
            margin-bottom: 12px;
            color: var(--primary);
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .copy-btn {
            margin-top: 12px;
        }

        .empty-state {
            text-align: center;
            padding: 64px 32px;
            color: var(--text-muted);
        }

        .empty-state i {
            font-size: 4rem;
            margin-bottom: 20px;
            opacity: 0.3;
            color: var(--primary);
        }

        .empty-state p {
            margin-bottom: 20px;
            font-size: 1rem;
        }

        .checkbox-group {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }

        .checkbox-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 12px 18px;
            background: var(--bg-warm);
            border-radius: 50px;
            cursor: pointer;
            border: 2px solid transparent;
            transition: all 0.2s ease;
            font-weight: 500;
        }

        .checkbox-item:hover {
            border-color: var(--primary);
            background: var(--bg);
        }

        .checkbox-item input {
            cursor: pointer;
            accent-color: var(--primary);
            width: 18px;
            height: 18px;
        }

        @page {
            size: landscape;
            margin: 10mm;
        }

        @media print {
            * {
                -webkit-print-color-adjust: exact !important;
                print-color-adjust: exact !important;
            }

            html, body {
                background: white;
                font-size: 8pt;
                width: 100%;
                margin: 0;
                padding: 0;
            }

            .container {
                max-width: 100%;
                padding: 0;
                margin: 0;
            }
            
            /* Hide UI elements */
            .tabs, .btn, header, .modal-overlay, .stats-grid,
            .filter-group, .view-toggle, .action-buttons,
            .card-header, .timeline-legend, .member-timeline {
                display: none !important;
            }

            /* Show print header */
            .print-only {
                display: block !important;
                margin-bottom: 10px !important;
                padding-bottom: 8px !important;
            }

            .print-only h1 {
                font-size: 14pt !important;
                margin-bottom: 2px !important;
            }

            .print-only p {
                font-size: 9pt !important;
            }
            
            .card {
                box-shadow: none;
                border: none;
                padding: 0;
                margin: 0;
            }

            /* Timeline print styles */
            .timeline-container {
                overflow: hidden !important;
                width: 100% !important;
                max-width: 100% !important;
            }

            .timeline-grid {
                min-width: 0 !important;
                width: 100% !important;
                max-width: 100% !important;
                font-size: 6pt;
                display: table !important;
                table-layout: fixed !important;
                border-collapse: collapse;
            }

            .timeline-header,
            .timeline-row {
                display: table-row !important;
            }

            .timeline-header-cell,
            .timeline-cell,
            .timeline-role-cell {
                display: table-cell !important;
                border: 1px solid #ccc;
                vertical-align: middle;
            }

            .timeline-header-cell {
                padding: 3px 2px;
                font-size: 6pt;
                word-break: break-word;
                text-align: center;
                background: #1a1a2e !important;
                color: white !important;
            }

            .timeline-header-cell.role-header {
                width: 60px !important;
                min-width: 60px !important;
                max-width: 60px !important;
                background: #2d2d44 !important;
            }

            .timeline-cell {
                padding: 2px;
                height: 28px;
                vertical-align: top;
            }

            .timeline-slot {
                padding: 1px 2px;
                font-size: 5pt;
                border-radius: 2px;
                margin: 1px 0;
            }

            .timeline-slot i {
                display: none !important;
            }

            .timeline-role-cell {
                padding: 3px;
                font-size: 6pt;
                width: 60px !important;
                min-width: 60px !important;
                max-width: 60px !important;
                background: white !important;
            }

            .timeline-role-cell .role-dot {
                width: 6px;
                height: 6px;
                margin-right: 3px;
            }

            /* Summary cards print - kompakt rad */
            .summary-grid {
                display: flex !important;
                flex-wrap: nowrap;
                gap: 8px;
                margin-bottom: 10px;
                padding: 8px;
                background: #f5f5f5 !important;
                border-radius: 4px;
            }

            .summary-card {
                padding: 4px 8px;
                border-left-width: 2px;
                flex: 1;
                background: white !important;
            }

            .summary-card h4 {
                font-size: 6pt;
                margin-bottom: 2px;
            }

            .summary-card .value {
                font-size: 10pt;
            }

            /* List view print */
            .person-schedule {
                page-break-inside: avoid;
                margin-bottom: 8px;
                border: 1px solid #ddd;
                padding: 8px;
                border-radius: 4px;
            }

            .person-schedule h3 {
                font-size: 9pt;
                border-bottom: 1px solid #ddd;
                padding-bottom: 4px;
                margin-bottom: 4px;
            }

            .schedule-item {
                padding: 4px;
                margin-bottom: 2px;
                font-size: 7pt;
            }

            .role-tag {
                font-size: 6pt;
                padding: 1px 4px;
            }
        }

        .print-only {
            display: none;
        }

        @media (max-width: 768px) {
            .container {
                padding: 16px;
            }
            
            .header-content {
                padding: 20px;
            }

            header h1 {
                font-size: 1.75rem;
            }

            header::before {
                width: 30%;
                opacity: 0.5;
            }
            
            .header-actions {
                flex-wrap: wrap;
            }

            .header-actions .btn {
                flex: 1;
                justify-content: center;
                min-width: 80px;
            }
            
            .card {
                padding: 20px;
            }

            .card-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 16px;
            }

            .card-header h2 {
                font-size: 1.4rem;
            }
            
            .tabs {
                flex-direction: column;
                gap: 2px;
            }
            
            .tab-btn {
                width: 100%;
                justify-content: center;
                padding: 16px;
            }

            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
                gap: 12px;
            }

            .stat-card {
                padding: 16px;
                flex-direction: column;
                text-align: center;
            }

            .stat-card .value {
                font-size: 2rem;
            }

            .stat-card i {
                font-size: 1.3rem;
            }

            /* Members table - card layout on mobile */
            #members-tab table,
            #members-tab thead,
            #members-tab tbody,
            #members-tab th,
            #members-tab td,
            #members-tab tr {
                display: block;
            }

            #members-tab thead {
                display: none;
            }

            #members-tab tr {
                margin-bottom: 12px;
                background: var(--bg);
                border-radius: 8px;
                padding: 12px;
                border: 1px solid var(--border);
            }

            #members-tab td {
                padding: 4px 0;
                border: none;
                display: flex;
                justify-content: space-between;
                align-items: center;
            }

            #members-tab td:before {
                content: attr(data-label);
                font-weight: 600;
                color: var(--text-muted);
                font-size: 0.8rem;
                text-transform: uppercase;
            }

            #members-tab td:first-child {
                font-size: 1.1rem;
                font-weight: 600;
                border-bottom: 1px solid var(--border);
                padding-bottom: 8px;
                margin-bottom: 4px;
            }

            #members-tab td:first-child:before {
                display: none;
            }

            #members-tab td:last-child {
                justify-content: flex-end;
                padding-top: 8px;
                border-top: 1px solid var(--border);
                margin-top: 4px;
            }

            #members-tab td:last-child:before {
                display: none;
            }

            /* Roles table */
            #roles-tab table {
                font-size: 0.85rem;
            }
            
            #roles-tab th, 
            #roles-tab td {
                padding: 8px;
            }

            #roles-tab th:nth-child(2),
            #roles-tab td:nth-child(2) {
                display: none;
            }

            /* Timeline mobile styles */
            .timeline-container {
                overflow-x: auto;
                margin: 0 -12px;
                padding: 0 12px;
            }

            .timeline-grid {
                min-width: 600px;
                font-size: 0.75rem;
            }

            .timeline-header-cell {
                padding: 8px 4px;
                font-size: 0.7rem;
            }

            .timeline-header-cell.role-header {
                min-width: 60px !important;
            }

            .timeline-role-cell {
                padding: 8px 4px;
                font-size: 0.75rem;
                min-width: 60px !important;
            }

            .timeline-role-cell .role-dot {
                display: none;
            }

            .timeline-cell {
                padding: 4px;
                min-height: 50px;
            }

            .timeline-slot {
                padding: 4px 6px;
                font-size: 0.7rem;
            }

            .timeline-slot i {
                display: none;
            }

            /* Summary grid mobile */
            .summary-grid {
                grid-template-columns: repeat(2, 1fr);
                gap: 8px;
            }

            .summary-card {
                padding: 12px;
            }

            .summary-card .value {
                font-size: 1.3rem;
            }

            /* Member timeline mobile */
            .member-timeline h3 {
                font-size: 1rem;
            }

            .member-row {
                flex-direction: column;
            }

            .member-name {
                min-width: auto;
                width: 100%;
                border-right: none;
                border-bottom: 1px solid var(--border);
                padding: 8px 12px;
            }

            .member-shifts {
                padding: 8px;
                flex-wrap: wrap;
            }

            .member-shift-block {
                font-size: 0.75rem;
                padding: 6px 10px;
            }

            /* View toggle mobile */
            .view-toggle {
                margin-right: 0;
                margin-bottom: 8px;
            }

            .action-buttons {
                flex-direction: column;
                width: 100%;
            }

            /* Event cards mobile */
            .event-card-header {
                flex-direction: column;
                gap: 8px;
            }

            .event-card-title {
                font-size: 1rem;
            }

            .shift-item {
                flex-direction: column;
                align-items: flex-start;
                gap: 8px;
            }

            .shift-info {
                flex-wrap: wrap;
            }

            /* Filter group mobile */
            .filter-group {
                flex-direction: column;
            }

            .filter-group select {
                max-width: 100% !important;
            }

            /* Modal mobile */
            .modal {
                padding: 16px;
                max-height: 95vh;
            }

            .form-row {
                grid-template-columns: 1fr;
            }

            /* Person schedule list view */
            .person-schedule h3 {
                font-size: 1rem;
            }

            .schedule-details {
                flex-direction: column;
                gap: 4px;
            }

            .schedule-details span[style*="margin: 0 8px"] {
                display: none;
            }
        }

        .action-buttons {
            display: flex;
            gap: 12px;
            align-items: center;
        }

        .select-member {
            min-width: 200px;
        }

        /* Past events collapsible */
        .past-events-header {
            background: var(--bg-warm);
            border-radius: var(--radius-lg);
            padding: 16px 20px;
            margin-bottom: 16px;
            border: 1px solid var(--border);
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .past-events-header:hover {
            background: var(--bg);
            border-color: var(--primary);
        }

        .past-events-header h3 {
            font-family: var(--font-display);
            font-size: 1.1rem;
            letter-spacing: 1px;
            text-transform: uppercase;
            color: var(--text-muted);
        }

        .filter-group {
            display: flex;
            gap: 16px;
            flex-wrap: wrap;
            margin-bottom: 20px;
            align-items: center;
        }

        .role-tag {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 50px;
            font-weight: 600;
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            font-size: 0.8rem;
            background: #e0e7ff;
            color: #4338ca;
        }

        /* View Toggle */
        .view-toggle {
            display: inline-flex;
            background: var(--bg-warm);
            border-radius: 50px;
            padding: 4px;
            margin-right: 12px;
            border: 1px solid var(--border);
        }

        .view-btn {
            padding: 10px 20px;
            border: none;
            background: transparent;
            color: var(--text-muted);
            border-radius: 50px;
            cursor: pointer;
            font-size: 0.85rem;
            font-weight: 600;
            transition: all 0.25s ease;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .view-btn:hover {
            color: var(--text);
        }

        .view-btn.active {
            background: var(--charcoal);
            color: white;
            box-shadow: 0 2px 8px rgba(26,26,46,0.2);
        }

        /* Timeline View */
        .timeline-container {
            overflow-x: auto;
            margin-top: 20px;
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow);
        }

        .timeline-grid {
            display: grid;
            min-width: 800px;
            gap: 1px;
            background: var(--border);
            border-radius: var(--radius-lg);
            overflow: hidden;
        }

        .timeline-header {
            display: contents;
        }

        .timeline-header-cell {
            background: var(--charcoal);
            color: white;
            padding: 14px 10px;
            text-align: center;
            font-weight: 700;
            font-size: 0.8rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .timeline-header-cell.role-header {
            background: var(--charcoal-light);
            text-align: left;
            min-width: 130px;
        }

        .timeline-row {
            display: contents;
        }

        .timeline-role-cell {
            background: var(--card);
            padding: 14px;
            font-weight: 700;
            font-size: 0.9rem;
            display: flex;
            align-items: center;
            gap: 10px;
            border-right: 3px solid var(--bg-warm);
        }

        .timeline-cell {
            background: var(--card);
            padding: 10px;
            min-height: 75px;
            display: flex;
            flex-direction: column;
            gap: 6px;
            transition: background 0.2s ease;
        }

        .timeline-cell:hover {
            background: var(--bg-warm);
        }

        .timeline-cell.unassigned {
            background: #fffbeb;
        }

        .timeline-slot {
            padding: 8px 12px;
            border-radius: var(--radius);
            font-size: 0.8rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            transition: all 0.2s ease;
        }

        .timeline-slot:hover {
            transform: scale(1.02);
        }

        .timeline-slot.assigned {
            background: var(--success-light);
            color: var(--success);
            border: 2px solid #86efac;
        }

        .timeline-slot.unassigned {
            background: var(--danger-light);
            color: var(--danger);
            border: 2px solid #fca5a5;
        }

        .timeline-slot i {
            flex-shrink: 0;
        }

        /* Role colors for timeline - warm palette */
        .role-color-0 { border-left: 4px solid #e85d04; }
        .role-color-1 { border-left: 4px solid #059669; }
        .role-color-2 { border-left: 4px solid #7c3aed; }
        .role-color-3 { border-left: 4px solid #db2777; }
        .role-color-4 { border-left: 4px solid #0891b2; }
        .role-color-5 { border-left: 4px solid #ca8a04; }
        .role-color-6 { border-left: 4px solid #dc2626; }

        .role-dot {
            width: 14px;
            height: 14px;
            border-radius: 4px;
            flex-shrink: 0;
        }

        .role-dot-0 { background: #e85d04; }
        .role-dot-1 { background: #059669; }
        .role-dot-2 { background: #7c3aed; }
        .role-dot-3 { background: #db2777; }
        .role-dot-4 { background: #0891b2; }
        .role-dot-5 { background: #ca8a04; }
        .role-dot-6 { background: #dc2626; }

        /* Summary cards */
        .summary-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
            margin-bottom: 28px;
        }

        .summary-card {
            background: var(--card);
            border-radius: var(--radius-lg);
            padding: 20px;
            border-left: 4px solid var(--primary);
            box-shadow: var(--shadow);
            transition: all 0.2s ease;
        }

        .summary-card:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
        }

        .summary-card h4 {
            font-size: 0.75rem;
            color: var(--text-muted);
            margin-bottom: 8px;
            text-transform: uppercase;
            letter-spacing: 1px;
            font-weight: 700;
        }

        .summary-card .value {
            font-family: var(--font-display);
            font-size: 2rem;
            font-weight: 400;
            letter-spacing: 1px;
            color: var(--charcoal);
        }

        /* Legend */
        .timeline-legend {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            margin-bottom: 20px;
            padding: 16px 20px;
            background: var(--card);
            border-radius: var(--radius-lg);
            border: 1px solid var(--border);
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 0.85rem;
            font-weight: 500;
        }

        /* Member timeline view */
        .member-timeline {
            margin-top: 28px;
        }

        .member-timeline h3 {
            font-family: var(--font-display);
            font-size: 1.25rem;
            letter-spacing: 1px;
            text-transform: uppercase;
            margin-bottom: 16px;
            color: var(--charcoal);
        }

        .member-row {
            display: flex;
            align-items: stretch;
            margin-bottom: 10px;
            background: var(--card);
            border-radius: var(--radius-lg);
            overflow: hidden;
            box-shadow: var(--shadow);
            border: 1px solid var(--border);
            transition: all 0.2s ease;
        }

        .member-row:hover {
            transform: translateX(4px);
            box-shadow: var(--shadow-lg);
        }

        .member-name {
            min-width: 160px;
            padding: 14px 18px;
            background: var(--bg-warm);
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 10px;
            border-right: 3px solid var(--primary);
            color: var(--charcoal);
        }

        .member-shifts {
            flex: 1;
            display: flex;
            align-items: center;
            padding: 10px;
            gap: 8px;
            overflow-x: auto;
        }

        .member-shift-block {
            padding: 10px 14px;
            border-radius: var(--radius);
            font-size: 0.8rem;
            font-weight: 600;
            white-space: nowrap;
            display: flex;
            flex-direction: column;
            gap: 4px;
            transition: all 0.2s ease;
        }

        .member-shift-block:hover {
            transform: scale(1.05);
        }

        .member-shift-block .time {
            font-family: var(--font-display);
            font-weight: 400;
            font-size: 0.95rem;
            letter-spacing: 0.5px;
        }

        .member-shift-block .role {
            font-size: 0.7rem;
            opacity: 0.8;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <div class="header-content">
                <h1><i class="ri-calendar-schedule-line"></i> FunktionÃ¤rsplanering</h1>
                <p>Bemanning fÃ¶r matcher, cuper och arrangemang</p>
                <div class="header-actions">
                    <button class="btn btn-sm" onclick="openExportModal()">
                        <i class="ri-download-2-line"></i> Exportera
                    </button>
                    <button class="btn btn-sm" onclick="openImportModal()">
                        <i class="ri-upload-2-line"></i> Importera
                    </button>
                    <button class="btn btn-sm" onclick="confirmDeleteAllData()" title="Radera all data" style="border-color: rgba(255,100,100,0.5);">
                        <i class="ri-delete-bin-line"></i>
                    </button>
                    <button class="btn btn-sm" onclick="showTutorial()" title="HjÃ¤lp & info">
                        <i class="ri-question-line"></i>
                    </button>
                </div>
            </div>
        </header>

        <div class="stats-grid">
            <div class="stat-card">
                <i class="ri-calendar-event-line"></i>
                <div class="value" id="statEvents">0</div>
                <div class="label">Evenemang</div>
            </div>
            <div class="stat-card">
                <i class="ri-time-line"></i>
                <div class="value" id="statShifts">0</div>
                <div class="label">Pass</div>
            </div>
            <div class="stat-card">
                <i class="ri-user-line"></i>
                <div class="value" id="statMembers">0</div>
                <div class="label">Medlemmar</div>
            </div>
            <div class="stat-card">
                <i class="ri-check-double-line"></i>
                <div class="value" id="statAssigned">0</div>
                <div class="label">Tilldelade</div>
            </div>
        </div>

        <div class="tabs">
            <button class="tab-btn active" data-tab="events">
                <i class="ri-calendar-event-line"></i> Evenemang
            </button>
            <button class="tab-btn" data-tab="members">
                <i class="ri-group-line"></i> Medlemmar
            </button>
            <button class="tab-btn" data-tab="roles">
                <i class="ri-price-tag-3-line"></i> Roller
            </button>
            <button class="tab-btn" data-tab="schedule">
                <i class="ri-table-line"></i> Schema
            </button>
            <button class="tab-btn" data-tab="messages">
                <i class="ri-message-2-line"></i> Meddelanden
            </button>
        </div>

        <!-- Evenemang Tab -->
        <div class="tab-content active" id="events-tab">
            <div class="card">
                <div class="card-header">
                    <h2><i class="ri-calendar-event-line"></i> Evenemang</h2>
                    <button class="btn btn-primary" onclick="openEventModal()">
                        <i class="ri-add-line"></i> Nytt evenemang
                    </button>
                </div>
                <div id="eventsList"></div>
            </div>
        </div>

        <!-- Medlemmar Tab -->
        <div class="tab-content" id="members-tab">
            <div class="card">
                <div class="card-header">
                    <h2><i class="ri-group-line"></i> Medlemmar</h2>
                    <button class="btn btn-primary" onclick="openMemberModal()">
                        <i class="ri-add-line"></i> LÃ¤gg till medlem
                    </button>
                </div>
                <table>
                    <thead>
                        <tr>
                            <th>Namn</th>
                            <th>Telefon</th>
                            <th>E-post</th>
                            <th>Tilldelade pass</th>
                            <th>Ã…tgÃ¤rder</th>
                        </tr>
                    </thead>
                    <tbody id="membersList"></tbody>
                </table>
            </div>
        </div>

        <!-- Roller Tab -->
        <div class="tab-content" id="roles-tab">
            <div class="card">
                <div class="card-header">
                    <h2><i class="ri-price-tag-3-line"></i> Roller</h2>
                    <button class="btn btn-primary" onclick="openRoleModal()">
                        <i class="ri-add-line"></i> Ny roll
                    </button>
                </div>
                <table>
                    <thead>
                        <tr>
                            <th>Roll</th>
                            <th>Beskrivning</th>
                            <th>Ã…tgÃ¤rder</th>
                        </tr>
                    </thead>
                    <tbody id="rolesList"></tbody>
                </table>
            </div>
        </div>

        <!-- Schema Tab -->
        <div class="tab-content" id="schedule-tab">
            <div class="card">
                <div class="card-header">
                    <h2><i class="ri-table-line"></i> Schema</h2>
                    <div class="action-buttons">
                        <div class="view-toggle">
                            <button class="view-btn active" data-view="timeline" onclick="setScheduleView('timeline')">
                                <i class="ri-layout-column-line"></i> Tidslinje
                            </button>
                            <button class="view-btn" data-view="list" onclick="setScheduleView('list')">
                                <i class="ri-list-check"></i> Lista
                            </button>
                        </div>
                        <button class="btn btn-secondary" onclick="window.print()">
                            <i class="ri-printer-line"></i> Skriv ut
                        </button>
                    </div>
                </div>
                <div class="filter-group">
                    <select class="form-control" id="scheduleEventFilter" style="max-width: 300px;" onchange="renderSchedule()">
                        <option value="">VÃ¤lj evenemang fÃ¶r tidslinje</option>
                    </select>
                    <select class="form-control" id="scheduleMemberFilter" style="max-width: 300px;" onchange="renderSchedule()">
                        <option value="">Alla medlemmar</option>
                    </select>
                </div>
                <div id="scheduleView"></div>
            </div>
        </div>

        <!-- Meddelanden Tab -->
        <div class="tab-content" id="messages-tab">
            <div class="card">
                <div class="card-header">
                    <h2><i class="ri-message-2-line"></i> Meddelanden per person</h2>
                </div>
                <div class="filter-group">
                    <select class="form-control" id="messageEventFilter" style="max-width: 300px;" onchange="renderMessages()">
                        <option value="">VÃ¤lj evenemang</option>
                    </select>
                    <button class="btn btn-secondary" onclick="toggleMessageTemplate()">
                        <i class="ri-settings-3-line"></i> Redigera mall
                    </button>
                </div>
                
                <!-- Message Template Editor -->
                <div id="messageTemplateEditor" style="display: none; margin-bottom: 20px;">
                    <div class="card" style="background: var(--bg); border: 2px solid var(--primary);">
                        <h4 style="margin-bottom: 12px;"><i class="ri-file-edit-line"></i> Meddelandemall</h4>
                        <p style="font-size: 0.85rem; color: var(--text-muted); margin-bottom: 12px;">
                            AnvÃ¤nd dessa platshÃ¥llare: <code>{namn}</code>, <code>{fÃ¶rnamn}</code>, <code>{evenemang}</code>, <code>{datum}</code>, <code>{plats}</code>, <code>{pass_lista}</code>, <code>{alla_pass}</code>
                        </p>
                        <p style="font-size: 0.8rem; color: var(--text-muted); margin-bottom: 12px;">
                            <code>{pass_lista}</code> = personens egna pass &nbsp;|&nbsp; <code>{alla_pass}</code> = hela schemat med telefonnummer
                        </p>
                        <textarea class="form-control" id="messageTemplate" rows="14" style="font-family: monospace; font-size: 0.9rem;"></textarea>
                        <div style="margin-top: 12px; display: flex; gap: 8px;">
                            <button class="btn btn-primary" onclick="saveMessageTemplate()">
                                <i class="ri-save-line"></i> Spara mall
                            </button>
                            <button class="btn btn-secondary" onclick="resetMessageTemplate()">
                                <i class="ri-refresh-line"></i> Ã…terstÃ¤ll standardmall
                            </button>
                        </div>
                    </div>
                </div>
                
                <div id="messagesView"></div>
            </div>
        </div>
    </div>

    <!-- Event Modal -->
    <div class="modal-overlay" id="eventModal">
        <div class="modal">
            <div class="modal-header">
                <h3 id="eventModalTitle">Nytt evenemang</h3>
                <button class="close-btn" onclick="closeEventModal()">
                    <i class="ri-close-line"></i>
                </button>
            </div>
            <form id="eventForm" onsubmit="saveEvent(event)">
                <input type="hidden" id="eventId">
                <div class="form-row">
                    <div class="form-group">
                        <label for="eventName">Namn *</label>
                        <input type="text" class="form-control" id="eventName" required placeholder="T.ex. Hemmamatch IFK">
                    </div>
                    <div class="form-group">
                        <label for="eventType">Typ</label>
                        <select class="form-control" id="eventType">
                            <option value="match">Match</option>
                            <option value="cup">Cup</option>
                            <option value="event">Arrangemang</option>
                        </select>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="eventDate">Datum *</label>
                        <input type="date" class="form-control" id="eventDate" required>
                    </div>
                    <div class="form-group">
                        <label for="eventLocation">Plats</label>
                        <input type="text" class="form-control" id="eventLocation" placeholder="T.ex. Hemmaplan">
                    </div>
                </div>
                <div class="form-group">
                    <label for="eventDescription">Beskrivning</label>
                    <textarea class="form-control" id="eventDescription" rows="2" placeholder="Ytterligare information..."></textarea>
                </div>
                <button type="submit" class="btn btn-primary">
                    <i class="ri-save-line"></i> Spara
                </button>
            </form>
        </div>
    </div>

    <!-- Shift Modal -->
    <div class="modal-overlay" id="shiftModal">
        <div class="modal">
            <div class="modal-header">
                <h3 id="shiftModalTitle">Nytt pass</h3>
                <button class="close-btn" onclick="closeShiftModal()">
                    <i class="ri-close-line"></i>
                </button>
            </div>
            <form id="shiftForm" onsubmit="saveShift(event)">
                <input type="hidden" id="shiftId">
                <input type="hidden" id="shiftEventId">
                <div class="form-row">
                    <div class="form-group">
                        <label for="shiftStartTime">Starttid *</label>
                        <input type="time" class="form-control" id="shiftStartTime" required>
                    </div>
                    <div class="form-group">
                        <label for="shiftEndTime">Sluttid *</label>
                        <input type="time" class="form-control" id="shiftEndTime" required>
                    </div>
                </div>
                <div class="form-group">
                    <label for="shiftRole">Roll *</label>
                    <select class="form-control" id="shiftRole" required>
                        <option value="">VÃ¤lj roll...</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="shiftCount">Antal personer</label>
                    <input type="number" class="form-control" id="shiftCount" min="1" value="1">
                </div>
                <div class="form-group">
                    <label>Tilldelade medlemmar</label>
                    <div id="shiftAssignedMembers" class="checkbox-group"></div>
                </div>
                <div class="form-group">
                    <label for="shiftNotes">Anteckningar</label>
                    <textarea class="form-control" id="shiftNotes" rows="2" placeholder="T.ex. sÃ¤rskilda instruktioner..."></textarea>
                </div>
                <button type="submit" class="btn btn-primary">
                    <i class="ri-save-line"></i> Spara
                </button>
            </form>
        </div>
    </div>

    <!-- Member Modal -->
    <div class="modal-overlay" id="memberModal">
        <div class="modal">
            <div class="modal-header">
                <h3 id="memberModalTitle">LÃ¤gg till medlem</h3>
                <button class="close-btn" onclick="closeMemberModal()">
                    <i class="ri-close-line"></i>
                </button>
            </div>
            <form id="memberForm" onsubmit="saveMember(event)">
                <input type="hidden" id="memberId">
                <div class="form-group">
                    <label for="memberName">Namn *</label>
                    <input type="text" class="form-control" id="memberName" required placeholder="FÃ¶rnamn Efternamn">
                </div>
                <div class="form-group">
                    <label for="memberPhone">Telefon</label>
                    <input type="tel" class="form-control" id="memberPhone" placeholder="070-123 45 67">
                </div>
                <div class="form-group">
                    <label for="memberEmail">E-post</label>
                    <input type="email" class="form-control" id="memberEmail" placeholder="namn@exempel.se">
                </div>
                <div class="form-group">
                    <label for="memberNotes">Anteckningar</label>
                    <textarea class="form-control" id="memberNotes" rows="2" placeholder="T.ex. tillgÃ¤nglighet, preferenser..."></textarea>
                </div>
                <div style="padding: 12px; background: #fef3c7; border-radius: 8px; margin-bottom: 16px; font-size: 0.85rem; color: #92400e;">
                    <i class="ri-shield-user-line"></i> <strong>Personuppgifter:</strong> 
                    Se till att personen har gett sitt medgivande till att du sparar deras kontaktuppgifter fÃ¶r schemalÃ¤ggning.
                </div>
                <button type="submit" class="btn btn-primary">
                    <i class="ri-save-line"></i> Spara
                </button>
            </form>
        </div>
    </div>

    <!-- Role Modal -->
    <div class="modal-overlay" id="roleModal">
        <div class="modal">
            <div class="modal-header">
                <h3 id="roleModalTitle">Ny roll</h3>
                <button class="close-btn" onclick="closeRoleModal()">
                    <i class="ri-close-line"></i>
                </button>
            </div>
            <form id="roleForm" onsubmit="saveRole(event)">
                <input type="hidden" id="roleId">
                <div class="form-group">
                    <label for="roleName">Rollnamn *</label>
                    <input type="text" class="form-control" id="roleName" required placeholder="T.ex. Kiosk">
                </div>
                <div class="form-group">
                    <label for="roleDescription">Beskrivning</label>
                    <textarea class="form-control" id="roleDescription" rows="2" placeholder="Vad innebÃ¤r denna roll..."></textarea>
                </div>
                <button type="submit" class="btn btn-primary">
                    <i class="ri-save-line"></i> Spara
                </button>
            </form>
        </div>
    </div>

    <!-- Bulk Shift Modal -->
    <div class="modal-overlay" id="bulkShiftModal">
        <div class="modal">
            <div class="modal-header">
                <h3>Generera pass fÃ¶r hela dagen</h3>
                <button class="close-btn" onclick="closeBulkShiftModal()">
                    <i class="ri-close-line"></i>
                </button>
            </div>
            <form id="bulkShiftForm" onsubmit="saveBulkShifts(event)">
                <input type="hidden" id="bulkEventId">
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="bulkStartTime">Starttid fÃ¶r dagen *</label>
                        <input type="time" class="form-control" id="bulkStartTime" value="09:00" required>
                    </div>
                    <div class="form-group">
                        <label for="bulkEndTime">Sluttid fÃ¶r dagen *</label>
                        <input type="time" class="form-control" id="bulkEndTime" value="15:00" required>
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="bulkDuration">PasslÃ¤ngd (minuter) *</label>
                        <select class="form-control" id="bulkDuration" required>
                            <option value="30">30 minuter</option>
                            <option value="45">45 minuter</option>
                            <option value="60" selected>1 timme</option>
                            <option value="90">1,5 timmar</option>
                            <option value="120">2 timmar</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="bulkCount">Antal personer per pass</label>
                        <input type="number" class="form-control" id="bulkCount" min="1" value="1">
                    </div>
                </div>
                
                <div class="form-group">
                    <label>VÃ¤lj roller att generera pass fÃ¶r *</label>
                    <div id="bulkRoles" class="checkbox-group"></div>
                </div>
                
                <div class="form-group" style="background: var(--bg); padding: 16px; border-radius: 8px;">
                    <label style="margin-bottom: 8px;"><i class="ri-eye-line"></i> FÃ¶rhandsvisning</label>
                    <div id="bulkPreview" style="font-size: 0.9rem; color: var(--text-muted);"></div>
                </div>
                
                <button type="submit" class="btn btn-primary">
                    <i class="ri-magic-line"></i> Skapa pass
                </button>
            </form>
        </div>
    </div>

    <!-- Tutorial Modal -->
    <div class="modal-overlay" id="tutorialModal">
        <div class="modal" style="max-width: 550px;">
            <div class="modal-header">
                <h3><i class="ri-lightbulb-line" style="color: var(--primary);"></i> VÃ¤lkommen!</h3>
                <button class="close-btn" onclick="closeTutorial()">
                    <i class="ri-close-line"></i>
                </button>
            </div>
            <div style="line-height: 1.7;">
                <div style="text-align: center; padding: 24px 0; background: linear-gradient(135deg, var(--charcoal) 0%, var(--charcoal-light) 100%); border-radius: var(--radius-lg); margin-bottom: 20px; position: relative; overflow: hidden;">
                    <div style="position: absolute; top: 0; right: 0; width: 40%; height: 100%; background: repeating-linear-gradient(-45deg, transparent, transparent 8px, rgba(232, 93, 4, 0.1) 8px, rgba(232, 93, 4, 0.1) 16px);"></div>
                    <i class="ri-calendar-schedule-line" style="font-size: 3rem; color: var(--primary); position: relative; z-index: 1;"></i>
                    <h2 style="margin-top: 12px; color: white; font-family: var(--font-display); letter-spacing: 2px; font-size: 1.75rem; position: relative; z-index: 1;">FUNKTIONÃ„RSPLANERING</h2>
                    <p style="color: rgba(255,255,255,0.7); position: relative; z-index: 1;">Enkel schemalÃ¤ggning fÃ¶r matcher och arrangemang</p>
                </div>

                <div style="background: var(--bg-warm); padding: 18px; border-radius: var(--radius-lg); margin-bottom: 16px; border-left: 4px solid var(--primary);">
                    <h4 style="margin-bottom: 8px; font-weight: 700;"><i class="ri-smartphone-line" style="color: var(--primary);"></i> Sparas i din webblÃ¤sare</h4>
                    <p style="font-size: 0.9rem; margin: 0; color: var(--text-muted);">
                        All data sparas <strong style="color: var(--text);">lokalt i din webblÃ¤sare</strong> â€“ inte pÃ¥ nÃ¥gon server. 
                        Det betyder att dina uppgifter Ã¤r privata och stannar pÃ¥ din enhet.
                    </p>
                </div>

                <div style="background: #fffbeb; padding: 18px; border-radius: var(--radius-lg); margin-bottom: 16px; border-left: 4px solid #d97706;">
                    <h4 style="margin-bottom: 8px; font-weight: 700; color: #92400e;"><i class="ri-error-warning-line"></i> Viktigt att veta</h4>
                    <ul style="font-size: 0.9rem; margin: 0; padding-left: 20px; color: #78350f;">
                        <li>Om du rensar webblÃ¤sardata fÃ¶rsvinner allt</li>
                        <li>Data delas inte automatiskt mellan enheter</li>
                        <li>AnvÃ¤nd <strong>Exportera</strong> fÃ¶r att spara en backup</li>
                    </ul>
                </div>

                <div style="background: var(--success-light); padding: 18px; border-radius: var(--radius-lg); margin-bottom: 16px; border-left: 4px solid var(--success);">
                    <h4 style="margin-bottom: 8px; font-weight: 700; color: #065f46;"><i class="ri-share-line"></i> Dela med andra</h4>
                    <p style="font-size: 0.9rem; margin: 0; color: #047857;">
                        Vill du dela upplÃ¤gget med nÃ¥gon annan? AnvÃ¤nd <strong>Exportera</strong> fÃ¶r att kopiera 
                        datan och skicka via SMS, mail eller WhatsApp. De kan sedan <strong>Importera</strong> pÃ¥ sin enhet.
                    </p>
                </div>

                <div style="background: #faf5ff; padding: 18px; border-radius: var(--radius-lg); margin-bottom: 20px; border-left: 4px solid #7c3aed;">
                    <h4 style="margin-bottom: 8px; font-weight: 700; color: #5b21b6;"><i class="ri-smartphone-line"></i> Spara som app pÃ¥ mobilen</h4>
                    <p style="font-size: 0.9rem; margin-bottom: 12px; color: #6d28d9;">
                        Du kan lÃ¤gga till denna sida pÃ¥ din hemskÃ¤rm sÃ¥ fungerar den som en app!
                    </p>
                    
                    <div id="ios-instructions" style="display: none; background: white; padding: 14px; border-radius: var(--radius); border: 1px solid #e9d5ff;">
                        <strong style="font-size: 0.85rem; color: var(--charcoal);"><i class="ri-apple-fill"></i> iPhone / iPad (Safari):</strong>
                        <ol style="font-size: 0.85rem; margin: 10px 0 0 0; padding-left: 20px; color: var(--text-muted);">
                            <li>Tryck pÃ¥ <strong style="color: var(--text);">Dela</strong>-ikonen <span style="border: 1px solid #ddd; padding: 2px 8px; border-radius: 4px; background: #f9fafb;">â–¡â†‘</span></li>
                            <li>Scrolla ner och tryck <strong style="color: var(--text);">"LÃ¤gg till pÃ¥ hemskÃ¤rmen"</strong></li>
                            <li>Tryck <strong style="color: var(--text);">LÃ¤gg till</strong></li>
                        </ol>
                        <p style="font-size: 0.8rem; color: var(--text-muted); margin-top: 10px; margin-bottom: 0; padding: 8px; background: #fef3c7; border-radius: 4px;">
                            ðŸ’¡ iOS 18+: LÃ¥t "Ã–ppna som webbapp" vara <strong>pÃ¥</strong>
                        </p>
                    </div>
                    
                    <div id="android-instructions" style="display: none; background: white; padding: 14px; border-radius: var(--radius); border: 1px solid #e9d5ff;">
                        <strong style="font-size: 0.85rem; color: var(--charcoal);"><i class="ri-android-fill"></i> Android (Chrome):</strong>
                        <ol style="font-size: 0.85rem; margin: 10px 0 0 0; padding-left: 20px; color: var(--text-muted);">
                            <li>Tryck pÃ¥ <strong style="color: var(--text);">menyn</strong> <span style="border: 1px solid #ddd; padding: 2px 8px; border-radius: 4px; background: #f9fafb;">â‹®</span></li>
                            <li>VÃ¤lj <strong style="color: var(--text);">"Installera app"</strong> eller <strong style="color: var(--text);">"LÃ¤gg till pÃ¥ startskÃ¤rmen"</strong></li>
                            <li>BekrÃ¤fta med <strong style="color: var(--text);">Installera</strong></li>
                        </ol>
                    </div>

                    <div id="desktop-instructions" style="display: none; background: white; padding: 14px; border-radius: var(--radius); border: 1px solid #e9d5ff;">
                        <strong style="font-size: 0.85rem; color: var(--charcoal);"><i class="ri-computer-line"></i> Dator:</strong>
                        <p style="font-size: 0.85rem; margin: 8px 0 0 0; color: var(--text-muted);">
                            PÃ¥ en dator kan du bokmÃ¤rka sidan eller besÃ¶ka den direkt. 
                            Vill du anvÃ¤nda den pÃ¥ mobilen? Ã–ppna lÃ¤nken pÃ¥ din telefon!
                        </p>
                    </div>
                </div>

                <h4 style="margin-bottom: 14px; font-family: var(--font-display); font-size: 1.1rem; letter-spacing: 1px; text-transform: uppercase;"><i class="ri-play-circle-line" style="color: var(--primary);"></i> Kom igÃ¥ng</h4>
                <ol style="font-size: 0.9rem; padding-left: 20px; margin-bottom: 24px; color: var(--text-muted);">
                    <li style="margin-bottom: 10px;"><strong style="color: var(--text);">LÃ¤gg till medlemmar</strong> â€“ de som ska bemanna</li>
                    <li style="margin-bottom: 10px;"><strong style="color: var(--text);">Skapa evenemang</strong> â€“ match, cup eller arrangemang</li>
                    <li style="margin-bottom: 10px;"><strong style="color: var(--text);">Generera pass</strong> â€“ t.ex. kiosk 09-15, 1 timme per pass</li>
                    <li style="margin-bottom: 10px;"><strong style="color: var(--text);">Bemanna</strong> â€“ fÃ¶rdela automatiskt eller manuellt</li>
                    <li style="margin-bottom: 10px;"><strong style="color: var(--text);">Skicka meddelanden</strong> â€“ via SMS, WhatsApp eller mail</li>
                </ol>

                <div style="display: flex; gap: 12px; flex-wrap: wrap;">
                    <button class="btn btn-primary" onclick="closeTutorial()" style="flex: 1;">
                        <i class="ri-check-line"></i> SÃ¤tt igÃ¥ng!
                    </button>
                    <button class="btn btn-secondary" onclick="closeTutorial(); openTutorialAgain();">
                        <i class="ri-eye-off-line"></i> Visa inte igen
                    </button>
                </div>

                <p style="text-align: center; margin-top: 20px; font-size: 0.8rem; color: var(--text-muted);">
                    <i class="ri-information-line"></i> Visa denna guide igen via <strong style="color: var(--primary);">?</strong>-knappen
                </p>
            </div>
        </div>
    </div>

    <!-- Export Modal -->
    <div class="modal-overlay" id="exportModal">
        <div class="modal" style="max-width: 600px;">
            <div class="modal-header">
                <h3><i class="ri-download-2-line"></i> Exportera data</h3>
                <button class="close-btn" onclick="closeExportModal()">
                    <i class="ri-close-line"></i>
                </button>
            </div>
            <div>
                <p style="margin-bottom: 16px; color: var(--text-muted);">
                    Exportera all data fÃ¶r att dela med nÃ¥gon annan eller som backup.
                </p>
                
                <div class="form-group">
                    <label>Vad vill du exportera?</label>
                    <div class="checkbox-group">
                        <label class="checkbox-item">
                            <input type="checkbox" id="exportMembers" checked>
                            Medlemmar
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" id="exportRoles" checked>
                            Roller
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" id="exportEvents" checked>
                            Evenemang
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" id="exportShifts" checked>
                            Pass & bemanning
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" id="exportTemplate" checked>
                            Meddelandemall
                        </label>
                    </div>
                </div>

                <div class="form-group">
                    <label>Exporterad data (JSON)</label>
                    <textarea class="form-control" id="exportData" rows="8" readonly style="font-family: monospace; font-size: 0.8rem;"></textarea>
                </div>

                <div style="display: flex; gap: 8px; flex-wrap: wrap;">
                    <button class="btn btn-primary" onclick="copyExportData()">
                        <i class="ri-file-copy-line"></i> Kopiera till urklipp
                    </button>
                    <button class="btn btn-secondary" onclick="downloadExportData()">
                        <i class="ri-download-line"></i> Ladda ner fil
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Import Modal -->
    <div class="modal-overlay" id="importModal">
        <div class="modal" style="max-width: 500px;">
            <div class="modal-header">
                <h3><i class="ri-upload-2-line"></i> Importera</h3>
                <button class="close-btn" onclick="closeImportModal()">
                    <i class="ri-close-line"></i>
                </button>
            </div>
            <div>
                <div class="form-group" style="margin-bottom: 12px;">
                    <label style="margin-bottom: 4px;">Klistra in JSON eller vÃ¤lj fil</label>
                    <textarea class="form-control" id="importData" rows="5" placeholder="Klistra in exporterad JSON-data hÃ¤r..." style="font-family: monospace; font-size: 0.75rem;"></textarea>
                </div>

                <div class="form-group" style="margin-bottom: 12px;">
                    <input type="file" class="form-control" id="importFile" accept=".json" onchange="loadImportFile(event)" style="padding: 10px;">
                </div>

                <div class="form-group" style="margin-bottom: 12px;">
                    <div style="display: flex; gap: 8px;">
                        <label class="checkbox-item" style="flex: 1; padding: 10px 14px; margin: 0;">
                            <input type="radio" name="importMode" value="merge" checked>
                            <div>
                                <strong style="font-size: 0.85rem;">SlÃ¥ ihop</strong>
                            </div>
                        </label>
                        <label class="checkbox-item" style="flex: 1; padding: 10px 14px; margin: 0;">
                            <input type="radio" name="importMode" value="replace">
                            <div>
                                <strong style="font-size: 0.85rem;">ErsÃ¤tt allt</strong>
                            </div>
                        </label>
                    </div>
                </div>

                <div id="importPreview" style="display: none; margin-bottom: 12px; padding: 10px; background: var(--bg-warm); border-radius: var(--radius); font-size: 0.85rem;">
                    <strong>FÃ¶rhandsvisning:</strong>
                    <div id="importPreviewContent"></div>
                </div>

                <div style="display: flex; gap: 8px;">
                    <button class="btn btn-secondary" onclick="previewImport()" style="flex: 1;">
                        <i class="ri-eye-line"></i> FÃ¶rhandsgranska
                    </button>
                    <button class="btn btn-primary" onclick="executeImport()" style="flex: 1;">
                        <i class="ri-upload-line"></i> Importera
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Copy Event Modal -->
    <div class="modal-overlay" id="copyEventModal">
        <div class="modal" style="max-width: 500px;">
            <div class="modal-header">
                <h3><i class="ri-file-copy-line"></i> Kopiera evenemang</h3>
                <button class="close-btn" onclick="closeCopyEventModal()">
                    <i class="ri-close-line"></i>
                </button>
            </div>
            <div id="copyEventContent">
                <input type="hidden" id="copyEventSourceId">
                
                <div class="form-group" style="background: var(--bg); padding: 16px; border-radius: 8px; margin-bottom: 16px;">
                    <label style="margin-bottom: 8px;"><i class="ri-information-line"></i> Kopierar frÃ¥n</label>
                    <div id="copyEventSourceInfo" style="font-weight: 600;"></div>
                </div>

                <div class="form-group">
                    <label for="copyEventNewName">Namn pÃ¥ nya evenemanget</label>
                    <input type="text" class="form-control" id="copyEventNewName" placeholder="T.ex. Hemmamatch IFK">
                </div>

                <div class="form-group">
                    <label for="copyEventNewDate">Nytt datum *</label>
                    <input type="date" class="form-control" id="copyEventNewDate" required>
                </div>

                <div class="form-group">
                    <label>Vad ska kopieras?</label>
                    <div class="checkbox-group">
                        <label class="checkbox-item">
                            <input type="checkbox" id="copyEventShifts" checked>
                            Alla pass (tider och roller)
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" id="copyEventAssignments">
                            BehÃ¥ll bemanning (tilldelade medlemmar)
                        </label>
                    </div>
                </div>

                <div class="form-group" style="background: #f0fdf4; padding: 16px; border-radius: 8px; border: 1px solid #bbf7d0;">
                    <label style="margin-bottom: 8px;"><i class="ri-eye-line"></i> FÃ¶rhandsvisning</label>
                    <div id="copyEventPreview" style="font-size: 0.9rem;"></div>
                </div>

                <button type="button" class="btn btn-primary" onclick="executeCopyEvent()">
                    <i class="ri-file-copy-line"></i> Skapa kopia
                </button>
            </div>
        </div>
    </div>

    <!-- Auto Assign Modal -->
    <div class="modal-overlay" id="autoAssignModal">
        <div class="modal" style="max-width: 700px;">
            <div class="modal-header">
                <h3><i class="ri-user-settings-line"></i> Automatisk bemanning</h3>
                <button class="close-btn" onclick="closeAutoAssignModal()">
                    <i class="ri-close-line"></i>
                </button>
            </div>
            <div id="autoAssignContent">
                <input type="hidden" id="autoAssignEventId">
                
                <div class="form-group">
                    <label>VÃ¤lj medlemmar som ska bemanna</label>
                    <div style="margin-bottom: 8px;">
                        <button type="button" class="btn btn-sm btn-secondary" onclick="toggleAllMembers(true)">
                            <i class="ri-checkbox-multiple-line"></i> VÃ¤lj alla
                        </button>
                        <button type="button" class="btn btn-sm btn-secondary" onclick="toggleAllMembers(false)">
                            <i class="ri-checkbox-blank-line"></i> Avmarkera alla
                        </button>
                    </div>
                    <div id="autoAssignMembers" class="checkbox-group"></div>
                </div>

                <div class="form-group">
                    <label>InstÃ¤llningar</label>
                    <div class="form-row">
                        <label class="checkbox-item" style="flex: 1;">
                            <input type="checkbox" id="autoAssignConsecutive" checked>
                            Ge sammanhÃ¤ngande pass till samma person
                        </label>
                    </div>
                    <div class="form-row">
                        <label class="checkbox-item" style="flex: 1;">
                            <input type="checkbox" id="autoAssignClearExisting">
                            Rensa befintlig bemanning fÃ¶rst
                        </label>
                    </div>
                </div>

                <div class="form-group" style="background: var(--bg); padding: 16px; border-radius: 8px;">
                    <label style="margin-bottom: 8px;"><i class="ri-information-line"></i> Sammanfattning</label>
                    <div id="autoAssignSummary" style="font-size: 0.9rem;"></div>
                </div>

                <div class="form-group" style="background: #f0fdf4; padding: 16px; border-radius: 8px; border: 1px solid #bbf7d0;">
                    <label style="margin-bottom: 8px;"><i class="ri-eye-line"></i> FÃ¶rhandsvisning av fÃ¶rdelning</label>
                    <div id="autoAssignPreview" style="font-size: 0.9rem;"></div>
                </div>

                <div style="display: flex; gap: 8px;">
                    <button type="button" class="btn btn-secondary" onclick="previewAutoAssign()">
                        <i class="ri-refresh-line"></i> Uppdatera fÃ¶rhandsvisning
                    </button>
                    <button type="button" class="btn btn-success" onclick="executeAutoAssign()">
                        <i class="ri-check-line"></i> GenomfÃ¶r bemanning
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ==================== DATA MANAGEMENT ====================
        const STORAGE_KEY = 'funktionarsplanering_data';

        const DEFAULT_MESSAGE_TEMPLATE = `Hej {fÃ¶rnamn}!

Du Ã¤r inbokad som funktionÃ¤r pÃ¥ {evenemang}.

ðŸ“… Datum: {datum}
ðŸ“ Plats: {plats}

Dina pass:
{pass_lista}

Vill du byta pass sÃ¥ ansvarar du sjÃ¤lv fÃ¶r att samordna det med annan funktionÃ¤r.

ðŸ“‹ Hela schemat:
{alla_pass}

HÃ¶r av dig om du har nÃ¥gra frÃ¥gor!

Mvh
FunktionÃ¤rsansvarig`;

        function getDefaultData() {
            return {
                events: [],
                members: [],
                roles: [
                    { id: generateId(), name: 'Kiosk', description: 'FÃ¶rsÃ¤ljning i kiosken' },
                    { id: generateId(), name: 'EntrÃ©', description: 'Ta emot besÃ¶kare och biljettfÃ¶rsÃ¤ljning' },
                    { id: generateId(), name: 'Sekretariat', description: 'Matchprotokoll och tidtagning' },
                    { id: generateId(), name: 'Speaker', description: 'Utrop och information' },
                    { id: generateId(), name: 'Parkeringsvakt', description: 'Dirigera parkering' }
                ],
                shifts: [],
                messageTemplate: DEFAULT_MESSAGE_TEMPLATE
            };
        }

        function loadData() {
            const stored = localStorage.getItem(STORAGE_KEY);
            if (stored) {
                return JSON.parse(stored);
            }
            return getDefaultData();
        }

        function saveData(data) {
            localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
        }

        let appData = loadData();

        function generateId() {
            return Date.now().toString(36) + Math.random().toString(36).substr(2);
        }

        // ==================== TAB NAVIGATION ====================
        document.querySelectorAll('.tab-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
                document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                
                btn.classList.add('active');
                document.getElementById(btn.dataset.tab + '-tab').classList.add('active');

                // Refresh data when switching tabs
                if (btn.dataset.tab === 'schedule') {
                    populateScheduleFilters();
                    renderSchedule();
                } else if (btn.dataset.tab === 'messages') {
                    populateMessageFilters();
                    renderMessages();
                }
            });
        });

        // ==================== EVENTS ====================
        function openEventModal(eventId = null) {
            const modal = document.getElementById('eventModal');
            const form = document.getElementById('eventForm');
            form.reset();
            
            if (eventId) {
                const event = appData.events.find(e => e.id === eventId);
                if (event) {
                    document.getElementById('eventModalTitle').textContent = 'Redigera evenemang';
                    document.getElementById('eventId').value = event.id;
                    document.getElementById('eventName').value = event.name;
                    document.getElementById('eventType').value = event.type;
                    document.getElementById('eventDate').value = event.date;
                    document.getElementById('eventLocation').value = event.location || '';
                    document.getElementById('eventDescription').value = event.description || '';
                }
            } else {
                document.getElementById('eventModalTitle').textContent = 'Nytt evenemang';
                document.getElementById('eventId').value = '';
            }
            
            modal.classList.add('active');
        }

        function closeEventModal() {
            document.getElementById('eventModal').classList.remove('active');
        }

        function saveEvent(e) {
            e.preventDefault();
            
            const id = document.getElementById('eventId').value || generateId();
            const eventData = {
                id,
                name: document.getElementById('eventName').value,
                type: document.getElementById('eventType').value,
                date: document.getElementById('eventDate').value,
                location: document.getElementById('eventLocation').value,
                description: document.getElementById('eventDescription').value
            };

            const existingIndex = appData.events.findIndex(ev => ev.id === id);
            if (existingIndex >= 0) {
                appData.events[existingIndex] = eventData;
            } else {
                appData.events.push(eventData);
            }

            saveData(appData);
            renderEvents();
            updateStats();
            closeEventModal();
        }

        function deleteEvent(id) {
            if (confirm('Ã„r du sÃ¤ker pÃ¥ att du vill ta bort detta evenemang? Alla tillhÃ¶rande pass tas ocksÃ¥ bort.')) {
                appData.events = appData.events.filter(e => e.id !== id);
                appData.shifts = appData.shifts.filter(s => s.eventId !== id);
                saveData(appData);
                renderEvents();
                updateStats();
            }
        }

        // ==================== COPY EVENT ====================
        function openCopyEventModal(eventId) {
            const modal = document.getElementById('copyEventModal');
            const sourceEvent = appData.events.find(e => e.id === eventId);
            
            if (!sourceEvent) return;

            document.getElementById('copyEventSourceId').value = eventId;
            document.getElementById('copyEventNewName').value = sourceEvent.name + ' (kopia)';
            document.getElementById('copyEventNewDate').value = '';
            document.getElementById('copyEventShifts').checked = true;
            document.getElementById('copyEventAssignments').checked = false;

            // Show source info
            const sourceInfo = document.getElementById('copyEventSourceInfo');
            const shiftsCount = appData.shifts.filter(s => s.eventId === eventId).length;
            sourceInfo.innerHTML = `
                <div>${sourceEvent.name}</div>
                <div style="font-weight: normal; color: var(--text-muted); font-size: 0.9rem;">
                    ${formatDateLong(sourceEvent.date)} â€¢ ${shiftsCount} pass
                </div>
            `;

            updateCopyEventPreview();

            // Add event listeners for preview update
            document.getElementById('copyEventNewName').addEventListener('input', updateCopyEventPreview);
            document.getElementById('copyEventNewDate').addEventListener('change', updateCopyEventPreview);
            document.getElementById('copyEventShifts').addEventListener('change', updateCopyEventPreview);
            document.getElementById('copyEventAssignments').addEventListener('change', updateCopyEventPreview);

            modal.classList.add('active');
        }

        function closeCopyEventModal() {
            document.getElementById('copyEventModal').classList.remove('active');
        }

        function updateCopyEventPreview() {
            const sourceId = document.getElementById('copyEventSourceId').value;
            const sourceEvent = appData.events.find(e => e.id === sourceId);
            const newName = document.getElementById('copyEventNewName').value || sourceEvent?.name;
            const newDate = document.getElementById('copyEventNewDate').value;
            const copyShifts = document.getElementById('copyEventShifts').checked;
            const copyAssignments = document.getElementById('copyEventAssignments').checked;

            const preview = document.getElementById('copyEventPreview');
            const shiftsCount = appData.shifts.filter(s => s.eventId === sourceId).length;

            let html = `<strong>${newName}</strong><br>`;
            
            if (newDate) {
                html += `<span style="color: var(--success);"><i class="ri-calendar-line"></i> ${formatDateLong(newDate)}</span><br>`;
            } else {
                html += `<span style="color: var(--warning);"><i class="ri-alert-line"></i> VÃ¤lj ett datum</span><br>`;
            }

            html += `<br>`;

            if (copyShifts) {
                html += `<span class="badge badge-success"><i class="ri-check-line"></i> ${shiftsCount} pass kopieras</span> `;
                if (copyAssignments) {
                    html += `<span class="badge badge-primary"><i class="ri-user-line"></i> Med bemanning</span>`;
                } else {
                    html += `<span class="badge badge-warning"><i class="ri-user-line"></i> Utan bemanning</span>`;
                }
            } else {
                html += `<span class="badge badge-warning">Inga pass kopieras</span>`;
            }

            preview.innerHTML = html;
        }

        function executeCopyEvent() {
            const sourceId = document.getElementById('copyEventSourceId').value;
            const sourceEvent = appData.events.find(e => e.id === sourceId);
            
            if (!sourceEvent) {
                alert('Kunde inte hitta kÃ¤llevenemanget.');
                return;
            }

            const newName = document.getElementById('copyEventNewName').value || sourceEvent.name + ' (kopia)';
            const newDate = document.getElementById('copyEventNewDate').value;
            const copyShifts = document.getElementById('copyEventShifts').checked;
            const copyAssignments = document.getElementById('copyEventAssignments').checked;

            if (!newDate) {
                alert('VÃ¤lj ett datum fÃ¶r det nya evenemanget.');
                return;
            }

            // Create new event
            const newEventId = generateId();
            const newEvent = {
                id: newEventId,
                name: newName,
                type: sourceEvent.type,
                date: newDate,
                location: sourceEvent.location,
                description: sourceEvent.description
            };

            appData.events.push(newEvent);

            // Copy shifts if selected
            if (copyShifts) {
                const sourceShifts = appData.shifts.filter(s => s.eventId === sourceId);
                
                sourceShifts.forEach(shift => {
                    const newShift = {
                        id: generateId(),
                        eventId: newEventId,
                        startTime: shift.startTime,
                        endTime: shift.endTime,
                        roleId: shift.roleId,
                        count: shift.count,
                        notes: shift.notes,
                        assignedMembers: copyAssignments ? [...(shift.assignedMembers || [])] : []
                    };
                    appData.shifts.push(newShift);
                });
            }

            saveData(appData);
            renderEvents();
            updateStats();
            closeCopyEventModal();

            // Show confirmation
            const shiftsCount = copyShifts ? appData.shifts.filter(s => s.eventId === sourceId).length : 0;
            alert(`Evenemang kopierat!\n\n"${newName}"\n${formatDateLong(newDate)}\n${shiftsCount} pass${copyAssignments ? ' med bemanning' : ''}`);
        }

        function getEventTypeLabel(type) {
            const labels = { match: 'Match', cup: 'Cup', event: 'Arrangemang' };
            return labels[type] || type;
        }

        function getEventTypeBadgeClass(type) {
            const classes = { match: 'badge-primary', cup: 'badge-warning', event: 'badge-success' };
            return classes[type] || 'badge-primary';
        }

        function renderEvents() {
            const container = document.getElementById('eventsList');
            
            if (appData.events.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <i class="ri-calendar-event-line"></i>
                        <p>Inga evenemang skapade Ã¤nnu</p>
                        <button class="btn btn-primary" onclick="openEventModal()">
                            <i class="ri-add-line"></i> Skapa ditt fÃ¶rsta evenemang
                        </button>
                    </div>
                `;
                return;
            }

            // Separate upcoming and past events
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            
            const upcomingEvents = appData.events
                .filter(e => new Date(e.date) >= today)
                .sort((a, b) => new Date(a.date) - new Date(b.date));
            
            const pastEvents = appData.events
                .filter(e => new Date(e.date) < today)
                .sort((a, b) => new Date(b.date) - new Date(a.date)); // Most recent first

            let html = '';

            // Render upcoming events
            if (upcomingEvents.length > 0) {
                html += `<h3 style="margin-bottom: 16px; color: var(--text);"><i class="ri-calendar-check-line"></i> Kommande evenemang (${upcomingEvents.length})</h3>`;
                html += upcomingEvents.map(event => renderEventCard(event, false)).join('');
            } else {
                html += `
                    <div style="padding: 24px; text-align: center; background: var(--bg); border-radius: 8px; margin-bottom: 24px;">
                        <i class="ri-calendar-line" style="font-size: 2rem; color: var(--text-muted);"></i>
                        <p style="color: var(--text-muted); margin-top: 8px;">Inga kommande evenemang</p>
                    </div>
                `;
            }

            // Render past events in collapsible section
            if (pastEvents.length > 0) {
                html += `
                    <div style="margin-top: 32px; border-top: 2px solid var(--border); padding-top: 24px;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; flex-wrap: wrap; gap: 8px;">
                            <h3 style="color: var(--text-muted); cursor: pointer;" onclick="togglePastEvents()">
                                <i class="ri-history-line"></i> Gamla evenemang (${pastEvents.length})
                                <i id="pastEventsToggleIcon" class="ri-arrow-down-s-line"></i>
                            </h3>
                            <button class="btn btn-sm btn-danger" onclick="confirmDeleteAllPastEvents()">
                                <i class="ri-delete-bin-line"></i> Radera alla gamla
                            </button>
                        </div>
                        <div id="pastEventsList" style="display: none;">
                            <div style="padding: 12px; background: #fef3c7; border-radius: 8px; margin-bottom: 16px; font-size: 0.9rem;">
                                <i class="ri-lightbulb-line"></i> <strong>Tips:</strong> Vill du Ã¥teranvÃ¤nda ett gammalt evenemang? 
                                Klicka pÃ¥ <i class="ri-file-copy-line"></i> fÃ¶r att kopiera det med nytt datum!
                            </div>
                            ${pastEvents.map(event => renderEventCard(event, true)).join('')}
                        </div>
                    </div>
                `;
            }

            container.innerHTML = html;
        }

        function renderEventCard(event, isPast) {
            const eventShifts = appData.shifts.filter(s => s.eventId === event.id);
            const assignedCount = eventShifts.reduce((sum, s) => sum + (s.assignedMembers?.length || 0), 0);
            const totalNeeded = eventShifts.reduce((sum, s) => sum + (s.count || 1), 0);
            
            const cardStyle = isPast ? 'opacity: 0.7; border-color: var(--border);' : '';
            const pastBadge = isPast ? '<span class="badge" style="background: #9ca3af; color: white;">Avslutat</span>' : '';

            return `
                <div class="event-card" style="${cardStyle}">
                    <div class="event-card-header">
                        <div>
                            <div class="event-card-title">${event.name}</div>
                            <div class="event-card-date">
                                <i class="ri-calendar-line"></i>
                                ${formatDate(event.date)}
                                ${event.location ? `<span style="margin-left: 12px;"><i class="ri-map-pin-line"></i> ${event.location}</span>` : ''}
                            </div>
                        </div>
                        <div style="display: flex; gap: 8px; align-items: center; flex-wrap: wrap;">
                            ${pastBadge}
                            <span class="badge ${getEventTypeBadgeClass(event.type)}">${getEventTypeLabel(event.type)}</span>
                            <button class="btn btn-sm btn-secondary" onclick="openCopyEventModal('${event.id}')" title="Kopiera evenemang">
                                <i class="ri-file-copy-line"></i>
                            </button>
                            ${!isPast ? `
                                <button class="btn btn-sm btn-secondary" onclick="openEventModal('${event.id}')" title="Redigera">
                                    <i class="ri-edit-line"></i>
                                </button>
                            ` : ''}
                            <button class="btn btn-sm btn-danger" onclick="deleteEvent('${event.id}')" title="Ta bort">
                                <i class="ri-delete-bin-line"></i>
                            </button>
                        </div>
                    </div>
                    ${event.description ? `<p style="color: var(--text-muted); margin-bottom: 12px;">${event.description}</p>` : ''}
                    ${!isPast ? `
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; flex-wrap: wrap; gap: 8px;">
                            <div>
                                <span class="badge ${assignedCount >= totalNeeded && totalNeeded > 0 ? 'badge-success' : 'badge-warning'}">
                                    ${assignedCount}/${totalNeeded} tilldelade
                                </span>
                            </div>
                            <div style="display: flex; gap: 8px; flex-wrap: wrap;">
                                <button class="btn btn-sm btn-success" onclick="openAutoAssignModal('${event.id}')" title="FÃ¶rdela pass automatiskt mellan medlemmar">
                                    <i class="ri-user-settings-line"></i> Bemanna
                                </button>
                                <button class="btn btn-sm btn-secondary" onclick="openBulkShiftModal('${event.id}')" title="Generera flera pass automatiskt">
                                    <i class="ri-magic-line"></i> Generera pass
                                </button>
                                <button class="btn btn-sm btn-primary" onclick="openShiftModal('${event.id}')">
                                    <i class="ri-add-line"></i> Nytt pass
                                </button>
                            </div>
                        </div>
                        <div class="shift-list">
                            ${eventShifts.length === 0 ? 
                                '<p style="color: var(--text-muted); text-align: center; padding: 12px;">Inga pass skapade fÃ¶r detta evenemang</p>' :
                                eventShifts.sort((a, b) => a.startTime.localeCompare(b.startTime)).map(shift => renderShiftItem(shift)).join('')
                            }
                        </div>
                    ` : `
                        <div style="padding: 8px; background: var(--bg); border-radius: 8px; font-size: 0.85rem; color: var(--text-muted);">
                            ${eventShifts.length} pass â€¢ ${assignedCount}/${totalNeeded} var tilldelade
                        </div>
                    `}
                </div>
            `;
        }

        function togglePastEvents() {
            const list = document.getElementById('pastEventsList');
            const icon = document.getElementById('pastEventsToggleIcon');
            const isHidden = list.style.display === 'none';
            list.style.display = isHidden ? 'block' : 'none';
            icon.className = isHidden ? 'ri-arrow-up-s-line' : 'ri-arrow-down-s-line';
        }

        function confirmDeleteAllPastEvents() {
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            const pastEvents = appData.events.filter(e => new Date(e.date) < today);
            
            if (pastEvents.length === 0) {
                alert('Inga gamla evenemang att ta bort.');
                return;
            }

            if (confirm(`Vill du ta bort alla ${pastEvents.length} gamla evenemang och deras pass?\n\nTips: Om du vill spara upplÃ¤gget, kopiera fÃ¶rst ett evenemang med kopiera-knappen!`)) {
                const pastEventIds = pastEvents.map(e => e.id);
                appData.events = appData.events.filter(e => !pastEventIds.includes(e.id));
                appData.shifts = appData.shifts.filter(s => !pastEventIds.includes(s.eventId));
                saveData(appData);
                renderEvents();
                updateStats();
                alert(`${pastEvents.length} gamla evenemang har tagits bort.`);
            }
        }

        function confirmDeleteAllData() {
            const summary = `
Du har:
â€¢ ${appData.members.length} medlemmar
â€¢ ${appData.roles.length} roller
â€¢ ${appData.events.length} evenemang
â€¢ ${appData.shifts.length} pass

Vill du RADERA ALL DATA?

Tips: Exportera fÃ¶rst om du vill ha en backup!`;

            if (confirm(summary)) {
                if (confirm('Ã„r du HELT SÃ„KER? Detta gÃ¥r inte att Ã¥ngra!')) {
                    localStorage.removeItem(STORAGE_KEY);
                    appData = getDefaultData();
                    renderEvents();
                    renderMembers();
                    renderRoles();
                    updateStats();
                    alert('All data har raderats.\n\nStandardrollerna har Ã¥terstÃ¤llts.');
                }
            }
        }

        function renderShiftItem(shift) {
            const role = appData.roles.find(r => r.id === shift.roleId);
            const assignedNames = (shift.assignedMembers || [])
                .map(id => appData.members.find(m => m.id === id))
                .filter(m => m)
                .map(m => m.name);
            
            const neededCount = shift.count || 1;
            const assignedCount = assignedNames.length;
            const statusClass = assignedCount >= neededCount ? 'badge-success' : 'badge-warning';

            return `
                <div class="shift-item">
                    <div class="shift-info">
                        <span class="shift-time">${shift.startTime} - ${shift.endTime}</span>
                        <span class="role-tag">${role?.name || 'OkÃ¤nd roll'}</span>
                        <span class="badge ${statusClass}">${assignedCount}/${neededCount}</span>
                    </div>
                    <div style="display: flex; align-items: center; gap: 12px;">
                        <span class="shift-assigned">
                            ${assignedNames.length > 0 ? assignedNames.join(', ') : 'Ej tilldelad'}
                        </span>
                        <div class="action-buttons">
                            <button class="btn btn-icon btn-secondary" onclick="openShiftModal('${shift.eventId}', '${shift.id}')" title="Redigera">
                                <i class="ri-edit-line"></i>
                            </button>
                            <button class="btn btn-icon btn-danger" onclick="deleteShift('${shift.id}')" title="Ta bort">
                                <i class="ri-delete-bin-line"></i>
                            </button>
                        </div>
                    </div>
                </div>
            `;
        }

        // ==================== SHIFTS ====================
        function openShiftModal(eventId, shiftId = null) {
            const modal = document.getElementById('shiftModal');
            const form = document.getElementById('shiftForm');
            form.reset();

            // Populate roles dropdown
            const roleSelect = document.getElementById('shiftRole');
            roleSelect.innerHTML = '<option value="">VÃ¤lj roll...</option>' + 
                appData.roles.map(r => `<option value="${r.id}">${r.name}</option>`).join('');

            // Populate members checkboxes
            const membersContainer = document.getElementById('shiftAssignedMembers');
            membersContainer.innerHTML = appData.members.length === 0 ?
                '<p style="color: var(--text-muted);">Inga medlemmar tillagda Ã¤nnu</p>' :
                appData.members.map(m => `
                    <label class="checkbox-item">
                        <input type="checkbox" name="assignedMember" value="${m.id}">
                        ${m.name}
                    </label>
                `).join('');

            document.getElementById('shiftEventId').value = eventId;

            if (shiftId) {
                const shift = appData.shifts.find(s => s.id === shiftId);
                if (shift) {
                    document.getElementById('shiftModalTitle').textContent = 'Redigera pass';
                    document.getElementById('shiftId').value = shift.id;
                    document.getElementById('shiftStartTime').value = shift.startTime;
                    document.getElementById('shiftEndTime').value = shift.endTime;
                    document.getElementById('shiftRole').value = shift.roleId;
                    document.getElementById('shiftCount').value = shift.count || 1;
                    document.getElementById('shiftNotes').value = shift.notes || '';

                    // Check assigned members
                    (shift.assignedMembers || []).forEach(id => {
                        const checkbox = membersContainer.querySelector(`input[value="${id}"]`);
                        if (checkbox) checkbox.checked = true;
                    });
                }
            } else {
                document.getElementById('shiftModalTitle').textContent = 'Nytt pass';
                document.getElementById('shiftId').value = '';
            }

            modal.classList.add('active');
        }

        function closeShiftModal() {
            document.getElementById('shiftModal').classList.remove('active');
        }

        function saveShift(e) {
            e.preventDefault();

            const assignedMembers = Array.from(document.querySelectorAll('input[name="assignedMember"]:checked'))
                .map(cb => cb.value);

            const id = document.getElementById('shiftId').value || generateId();
            const shiftData = {
                id,
                eventId: document.getElementById('shiftEventId').value,
                startTime: document.getElementById('shiftStartTime').value,
                endTime: document.getElementById('shiftEndTime').value,
                roleId: document.getElementById('shiftRole').value,
                count: parseInt(document.getElementById('shiftCount').value) || 1,
                notes: document.getElementById('shiftNotes').value,
                assignedMembers
            };

            const existingIndex = appData.shifts.findIndex(s => s.id === id);
            if (existingIndex >= 0) {
                appData.shifts[existingIndex] = shiftData;
            } else {
                appData.shifts.push(shiftData);
            }

            saveData(appData);
            renderEvents();
            updateStats();
            closeShiftModal();
        }

        function deleteShift(id) {
            if (confirm('Ã„r du sÃ¤ker pÃ¥ att du vill ta bort detta pass?')) {
                appData.shifts = appData.shifts.filter(s => s.id !== id);
                saveData(appData);
                renderEvents();
                updateStats();
            }
        }

        // ==================== BULK SHIFTS ====================
        function openBulkShiftModal(eventId) {
            const modal = document.getElementById('bulkShiftModal');
            const form = document.getElementById('bulkShiftForm');
            form.reset();
            
            document.getElementById('bulkEventId').value = eventId;
            document.getElementById('bulkStartTime').value = '09:00';
            document.getElementById('bulkEndTime').value = '15:00';
            document.getElementById('bulkDuration').value = '60';
            document.getElementById('bulkCount').value = '1';

            // Populate roles checkboxes
            const rolesContainer = document.getElementById('bulkRoles');
            rolesContainer.innerHTML = appData.roles.length === 0 ?
                '<p style="color: var(--text-muted);">Inga roller skapade Ã¤nnu. Skapa roller fÃ¶rst.</p>' :
                appData.roles.map(r => `
                    <label class="checkbox-item">
                        <input type="checkbox" name="bulkRole" value="${r.id}" onchange="updateBulkPreview()">
                        ${r.name}
                    </label>
                `).join('');

            updateBulkPreview();
            
            // Add event listeners for preview update
            document.getElementById('bulkStartTime').addEventListener('change', updateBulkPreview);
            document.getElementById('bulkEndTime').addEventListener('change', updateBulkPreview);
            document.getElementById('bulkDuration').addEventListener('change', updateBulkPreview);

            modal.classList.add('active');
        }

        function closeBulkShiftModal() {
            document.getElementById('bulkShiftModal').classList.remove('active');
        }

        function updateBulkPreview() {
            const startTime = document.getElementById('bulkStartTime').value;
            const endTime = document.getElementById('bulkEndTime').value;
            const duration = parseInt(document.getElementById('bulkDuration').value);
            const selectedRoles = Array.from(document.querySelectorAll('input[name="bulkRole"]:checked'))
                .map(cb => appData.roles.find(r => r.id === cb.value)?.name)
                .filter(n => n);

            const preview = document.getElementById('bulkPreview');

            if (!startTime || !endTime) {
                preview.innerHTML = 'Ange start- och sluttid';
                return;
            }

            const shifts = calculateShiftSlots(startTime, endTime, duration);
            
            if (shifts.length === 0) {
                preview.innerHTML = 'Inga pass kan skapas med dessa tider';
                return;
            }

            const roleText = selectedRoles.length > 0 
                ? `<br><strong>Roller:</strong> ${selectedRoles.join(', ')}`
                : '<br><span style="color: var(--warning);">VÃ¤lj minst en roll</span>';

            const totalShifts = shifts.length * Math.max(selectedRoles.length, 1);

            preview.innerHTML = `
                <strong>${shifts.length} pass per roll</strong> kommer skapas:
                <br>
                <div style="display: flex; flex-wrap: wrap; gap: 8px; margin-top: 8px;">
                    ${shifts.map(s => `<span class="badge badge-primary">${s.start} - ${s.end}</span>`).join('')}
                </div>
                ${roleText}
                <br><br>
                <strong>Totalt:</strong> ${selectedRoles.length > 0 ? totalShifts : 0} pass kommer att skapas
            `;
        }

        function calculateShiftSlots(startTime, endTime, durationMinutes) {
            const shifts = [];
            
            const [startHour, startMin] = startTime.split(':').map(Number);
            const [endHour, endMin] = endTime.split(':').map(Number);
            
            let currentMinutes = startHour * 60 + startMin;
            const endMinutes = endHour * 60 + endMin;

            while (currentMinutes + durationMinutes <= endMinutes) {
                const shiftStart = formatTimeFromMinutes(currentMinutes);
                const shiftEnd = formatTimeFromMinutes(currentMinutes + durationMinutes);
                shifts.push({ start: shiftStart, end: shiftEnd });
                currentMinutes += durationMinutes;
            }

            return shifts;
        }

        function formatTimeFromMinutes(totalMinutes) {
            const hours = Math.floor(totalMinutes / 60);
            const minutes = totalMinutes % 60;
            return `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}`;
        }

        function saveBulkShifts(e) {
            e.preventDefault();

            const eventId = document.getElementById('bulkEventId').value;
            const startTime = document.getElementById('bulkStartTime').value;
            const endTime = document.getElementById('bulkEndTime').value;
            const duration = parseInt(document.getElementById('bulkDuration').value);
            const count = parseInt(document.getElementById('bulkCount').value) || 1;
            const selectedRoles = Array.from(document.querySelectorAll('input[name="bulkRole"]:checked'))
                .map(cb => cb.value);

            if (selectedRoles.length === 0) {
                alert('VÃ¤lj minst en roll fÃ¶r att skapa pass.');
                return;
            }

            const shifts = calculateShiftSlots(startTime, endTime, duration);

            if (shifts.length === 0) {
                alert('Inga pass kan skapas med dessa tider. Kontrollera att sluttiden Ã¤r efter starttiden och att passlÃ¤ngden ryms.');
                return;
            }

            // Create shifts for each role and time slot
            let createdCount = 0;
            selectedRoles.forEach(roleId => {
                shifts.forEach(slot => {
                    const shiftData = {
                        id: generateId(),
                        eventId,
                        startTime: slot.start,
                        endTime: slot.end,
                        roleId,
                        count,
                        notes: '',
                        assignedMembers: []
                    };
                    appData.shifts.push(shiftData);
                    createdCount++;
                });
            });

            saveData(appData);
            renderEvents();
            updateStats();
            closeBulkShiftModal();

            // Show confirmation
            const roleNames = selectedRoles.map(id => appData.roles.find(r => r.id === id)?.name).join(', ');
            alert(`${createdCount} pass skapades!\n\nRoller: ${roleNames}\nTider: ${startTime} - ${endTime}\nPasslÃ¤ngd: ${duration} minuter`);
        }

        // ==================== AUTO ASSIGN ====================
        function openAutoAssignModal(eventId) {
            const modal = document.getElementById('autoAssignModal');
            document.getElementById('autoAssignEventId').value = eventId;
            
            // Populate members checkboxes
            const membersContainer = document.getElementById('autoAssignMembers');
            if (appData.members.length === 0) {
                membersContainer.innerHTML = '<p style="color: var(--warning);">Inga medlemmar tillagda Ã¤nnu. LÃ¤gg till medlemmar fÃ¶rst.</p>';
            } else {
                membersContainer.innerHTML = appData.members
                    .sort((a, b) => a.name.localeCompare(b.name, 'sv'))
                    .map(m => `
                        <label class="checkbox-item">
                            <input type="checkbox" name="autoAssignMember" value="${m.id}" checked>
                            ${m.name}
                        </label>
                    `).join('');
            }

            // Reset settings
            document.getElementById('autoAssignConsecutive').checked = true;
            document.getElementById('autoAssignClearExisting').checked = false;

            updateAutoAssignSummary(eventId);
            previewAutoAssign();
            
            modal.classList.add('active');
        }

        function closeAutoAssignModal() {
            document.getElementById('autoAssignModal').classList.remove('active');
        }

        function toggleAllMembers(select) {
            document.querySelectorAll('input[name="autoAssignMember"]').forEach(cb => {
                cb.checked = select;
            });
            previewAutoAssign();
        }

        function updateAutoAssignSummary(eventId) {
            const event = appData.events.find(e => e.id === eventId);
            const eventShifts = appData.shifts.filter(s => s.eventId === eventId);
            
            const totalSlots = eventShifts.reduce((sum, s) => sum + (s.count || 1), 0);
            const assignedSlots = eventShifts.reduce((sum, s) => sum + (s.assignedMembers?.length || 0), 0);
            const unassignedSlots = totalSlots - assignedSlots;

            // Group by role
            const byRole = {};
            eventShifts.forEach(shift => {
                const role = appData.roles.find(r => r.id === shift.roleId);
                const roleName = role?.name || 'OkÃ¤nd';
                if (!byRole[roleName]) byRole[roleName] = { total: 0, assigned: 0 };
                byRole[roleName].total += (shift.count || 1);
                byRole[roleName].assigned += (shift.assignedMembers?.length || 0);
            });

            const summaryContainer = document.getElementById('autoAssignSummary');
            summaryContainer.innerHTML = `
                <div style="margin-bottom: 8px;">
                    <strong>${event?.name || 'Evenemang'}</strong>
                </div>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 8px;">
                    <div>
                        <span class="badge badge-primary">${eventShifts.length} pass</span>
                    </div>
                    <div>
                        <span class="badge ${unassignedSlots > 0 ? 'badge-warning' : 'badge-success'}">
                            ${assignedSlots}/${totalSlots} bemannade
                        </span>
                    </div>
                </div>
                <div style="margin-top: 12px;">
                    <strong>Per roll:</strong>
                    <div style="display: flex; flex-wrap: wrap; gap: 8px; margin-top: 4px;">
                        ${Object.entries(byRole).map(([name, data]) => `
                            <span class="role-tag">${name}: ${data.assigned}/${data.total}</span>
                        `).join('')}
                    </div>
                </div>
            `;
        }

        function previewAutoAssign() {
            const eventId = document.getElementById('autoAssignEventId').value;
            const selectedMembers = Array.from(document.querySelectorAll('input[name="autoAssignMember"]:checked'))
                .map(cb => cb.value);
            const consecutiveMode = document.getElementById('autoAssignConsecutive').checked;
            const clearExisting = document.getElementById('autoAssignClearExisting').checked;

            const preview = document.getElementById('autoAssignPreview');

            if (selectedMembers.length === 0) {
                preview.innerHTML = '<span style="color: var(--warning);">VÃ¤lj minst en medlem</span>';
                return;
            }

            // Calculate assignment
            const assignment = calculateAutoAssignment(eventId, selectedMembers, consecutiveMode, clearExisting);

            if (assignment.unassignedSlots === 0 && assignment.memberAssignments.length === 0) {
                preview.innerHTML = '<span style="color: var(--text-muted);">Alla pass Ã¤r redan bemannade</span>';
                return;
            }

            // Display preview
            let html = '';
            
            if (assignment.memberAssignments.length > 0) {
                html += '<div style="display: grid; gap: 12px;">';
                assignment.memberAssignments.forEach(ma => {
                    const member = appData.members.find(m => m.id === ma.memberId);
                    html += `
                        <div style="background: white; padding: 12px; border-radius: 8px; border-left: 4px solid var(--primary);">
                            <strong>${member?.name || 'OkÃ¤nd'}</strong>
                            <span class="badge badge-primary" style="margin-left: 8px;">${ma.shifts.length} pass</span>
                            <div style="margin-top: 8px; display: flex; flex-wrap: wrap; gap: 4px;">
                                ${ma.shifts.map(s => {
                                    const role = appData.roles.find(r => r.id === s.roleId);
                                    return `<span class="badge badge-success">${s.startTime}-${s.endTime} (${role?.name || '?'})</span>`;
                                }).join('')}
                            </div>
                        </div>
                    `;
                });
                html += '</div>';
            }

            if (assignment.unassignedSlots > 0) {
                html += `<div style="margin-top: 12px; color: var(--warning);">
                    <i class="ri-alert-line"></i> ${assignment.unassignedSlots} platser kvarstÃ¥r obemannade (fÃ¶r fÃ¥ medlemmar valda)
                </div>`;
            }

            preview.innerHTML = html;
        }

        function calculateAutoAssignment(eventId, selectedMemberIds, consecutiveMode, clearExisting) {
            const eventShifts = appData.shifts
                .filter(s => s.eventId === eventId)
                .map(s => ({...s})); // Clone to not modify original

            // If clearing existing, reset all assignments
            if (clearExisting) {
                eventShifts.forEach(s => s.assignedMembers = []);
            }

            // Sort shifts by role, then by time
            eventShifts.sort((a, b) => {
                if (a.roleId !== b.roleId) return a.roleId.localeCompare(b.roleId);
                return a.startTime.localeCompare(b.startTime);
            });

            // Track how many shifts each member has been assigned
            const memberShiftCount = {};
            selectedMemberIds.forEach(id => memberShiftCount[id] = 0);

            // Track which shifts each member is assigned to (for preview)
            const memberAssignments = {};
            selectedMemberIds.forEach(id => memberAssignments[id] = []);

            // Count existing assignments for selected members
            eventShifts.forEach(shift => {
                (shift.assignedMembers || []).forEach(memberId => {
                    if (memberShiftCount[memberId] !== undefined) {
                        memberShiftCount[memberId]++;
                    }
                });
            });

            // Group shifts by role for consecutive assignment
            const shiftsByRole = {};
            eventShifts.forEach(shift => {
                if (!shiftsByRole[shift.roleId]) shiftsByRole[shift.roleId] = [];
                shiftsByRole[shift.roleId].push(shift);
            });

            // For each role, assign members to consecutive shifts
            Object.values(shiftsByRole).forEach(roleShifts => {
                // Sort by time
                roleShifts.sort((a, b) => a.startTime.localeCompare(b.startTime));

                if (consecutiveMode) {
                    // Assign consecutive shifts to the same member
                    assignConsecutiveShifts(roleShifts, selectedMemberIds, memberShiftCount, memberAssignments);
                } else {
                    // Simple round-robin assignment
                    assignRoundRobin(roleShifts, selectedMemberIds, memberShiftCount, memberAssignments);
                }
            });

            // Calculate unassigned slots
            let unassignedSlots = 0;
            eventShifts.forEach(shift => {
                const needed = shift.count || 1;
                const assigned = shift.assignedMembers?.length || 0;
                unassignedSlots += Math.max(0, needed - assigned);
            });

            // Convert memberAssignments to array format for preview
            const assignmentArray = selectedMemberIds
                .map(id => ({
                    memberId: id,
                    shifts: memberAssignments[id]
                }))
                .filter(ma => ma.shifts.length > 0);

            return {
                shifts: eventShifts,
                memberAssignments: assignmentArray,
                unassignedSlots
            };
        }

        function assignConsecutiveShifts(roleShifts, memberIds, memberShiftCount, memberAssignments) {
            // Group consecutive unassigned slots
            let currentGroup = [];
            const groups = [];

            roleShifts.forEach((shift, index) => {
                const neededSlots = (shift.count || 1) - (shift.assignedMembers?.length || 0);
                
                for (let i = 0; i < neededSlots; i++) {
                    // Check if this shift is consecutive with the previous
                    if (currentGroup.length > 0) {
                        const lastShift = currentGroup[currentGroup.length - 1];
                        if (lastShift.endTime === shift.startTime || lastShift.id === shift.id) {
                            currentGroup.push(shift);
                        } else {
                            if (currentGroup.length > 0) groups.push([...currentGroup]);
                            currentGroup = [shift];
                        }
                    } else {
                        currentGroup.push(shift);
                    }
                }
            });
            if (currentGroup.length > 0) groups.push(currentGroup);

            // Assign each group to the member with fewest shifts
            groups.forEach(group => {
                // Find member with least assignments
                const sortedMembers = [...memberIds].sort((a, b) => memberShiftCount[a] - memberShiftCount[b]);
                const memberId = sortedMembers[0];

                if (memberId) {
                    // Assign all shifts in group to this member
                    const uniqueShifts = [...new Set(group.map(s => s.id))];
                    uniqueShifts.forEach(shiftId => {
                        const shift = roleShifts.find(s => s.id === shiftId);
                        if (shift) {
                            if (!shift.assignedMembers) shift.assignedMembers = [];
                            if (!shift.assignedMembers.includes(memberId)) {
                                shift.assignedMembers.push(memberId);
                                memberShiftCount[memberId]++;
                                memberAssignments[memberId].push(shift);
                            }
                        }
                    });
                }
            });
        }

        function assignRoundRobin(roleShifts, memberIds, memberShiftCount, memberAssignments) {
            roleShifts.forEach(shift => {
                const needed = shift.count || 1;
                if (!shift.assignedMembers) shift.assignedMembers = [];

                while (shift.assignedMembers.length < needed) {
                    // Find member with least assignments who isn't already assigned to this shift
                    const sortedMembers = [...memberIds]
                        .filter(id => !shift.assignedMembers.includes(id))
                        .sort((a, b) => memberShiftCount[a] - memberShiftCount[b]);

                    if (sortedMembers.length === 0) break; // No more available members

                    const memberId = sortedMembers[0];
                    shift.assignedMembers.push(memberId);
                    memberShiftCount[memberId]++;
                    memberAssignments[memberId].push(shift);
                }
            });
        }

        function executeAutoAssign() {
            const eventId = document.getElementById('autoAssignEventId').value;
            const selectedMembers = Array.from(document.querySelectorAll('input[name="autoAssignMember"]:checked'))
                .map(cb => cb.value);
            const consecutiveMode = document.getElementById('autoAssignConsecutive').checked;
            const clearExisting = document.getElementById('autoAssignClearExisting').checked;

            if (selectedMembers.length === 0) {
                alert('VÃ¤lj minst en medlem fÃ¶r att bemanna.');
                return;
            }

            // Calculate and apply assignment
            const assignment = calculateAutoAssignment(eventId, selectedMembers, consecutiveMode, clearExisting);

            // Apply the assignments to actual data
            assignment.shifts.forEach(calculatedShift => {
                const actualShift = appData.shifts.find(s => s.id === calculatedShift.id);
                if (actualShift) {
                    actualShift.assignedMembers = calculatedShift.assignedMembers;
                }
            });

            saveData(appData);
            renderEvents();
            updateStats();
            closeAutoAssignModal();

            // Show summary
            const assignedCount = assignment.memberAssignments.reduce((sum, ma) => sum + ma.shifts.length, 0);
            alert(`Bemanning klar!\n\n${assignedCount} pass tilldelade till ${assignment.memberAssignments.length} medlemmar.${assignment.unassignedSlots > 0 ? `\n\n${assignment.unassignedSlots} platser Ã¤r fortfarande obemannade.` : ''}`);
        }

        // ==================== MEMBERS ====================
        function openMemberModal(memberId = null) {
            const modal = document.getElementById('memberModal');
            const form = document.getElementById('memberForm');
            form.reset();

            if (memberId) {
                const member = appData.members.find(m => m.id === memberId);
                if (member) {
                    document.getElementById('memberModalTitle').textContent = 'Redigera medlem';
                    document.getElementById('memberId').value = member.id;
                    document.getElementById('memberName').value = member.name;
                    document.getElementById('memberPhone').value = member.phone || '';
                    document.getElementById('memberEmail').value = member.email || '';
                    document.getElementById('memberNotes').value = member.notes || '';
                }
            } else {
                document.getElementById('memberModalTitle').textContent = 'LÃ¤gg till medlem';
                document.getElementById('memberId').value = '';
            }

            modal.classList.add('active');
        }

        function closeMemberModal() {
            document.getElementById('memberModal').classList.remove('active');
        }

        function saveMember(e) {
            e.preventDefault();

            const id = document.getElementById('memberId').value || generateId();
            const memberData = {
                id,
                name: document.getElementById('memberName').value,
                phone: document.getElementById('memberPhone').value,
                email: document.getElementById('memberEmail').value,
                notes: document.getElementById('memberNotes').value
            };

            const existingIndex = appData.members.findIndex(m => m.id === id);
            if (existingIndex >= 0) {
                appData.members[existingIndex] = memberData;
            } else {
                appData.members.push(memberData);
            }

            saveData(appData);
            renderMembers();
            updateStats();
            closeMemberModal();
        }

        function deleteMember(id) {
            if (confirm('Ã„r du sÃ¤ker pÃ¥ att du vill ta bort denna medlem? Medlemmen tas ocksÃ¥ bort frÃ¥n alla tilldelade pass.')) {
                appData.members = appData.members.filter(m => m.id !== id);
                // Remove from all shifts
                appData.shifts.forEach(shift => {
                    if (shift.assignedMembers) {
                        shift.assignedMembers = shift.assignedMembers.filter(mid => mid !== id);
                    }
                });
                saveData(appData);
                renderMembers();
                renderEvents();
                updateStats();
            }
        }

        function getMemberShiftCount(memberId) {
            return appData.shifts.filter(s => s.assignedMembers?.includes(memberId)).length;
        }

        function renderMembers() {
            const tbody = document.getElementById('membersList');
            
            if (appData.members.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="5">
                            <div class="empty-state">
                                <i class="ri-group-line"></i>
                                <p>Inga medlemmar tillagda Ã¤nnu</p>
                                <button class="btn btn-primary" onclick="openMemberModal()">
                                    <i class="ri-add-line"></i> LÃ¤gg till din fÃ¶rsta medlem
                                </button>
                            </div>
                        </td>
                    </tr>
                `;
                return;
            }

            tbody.innerHTML = appData.members
                .sort((a, b) => a.name.localeCompare(b.name, 'sv'))
                .map(member => `
                    <tr>
                        <td data-label="Namn"><strong>${member.name}</strong></td>
                        <td data-label="Telefon">${member.phone || '-'}</td>
                        <td data-label="E-post">${member.email || '-'}</td>
                        <td data-label="Pass">
                            <span class="badge badge-primary">${getMemberShiftCount(member.id)} pass</span>
                        </td>
                        <td data-label="">
                            <div class="action-buttons">
                                <button class="btn btn-sm btn-secondary" onclick="openMemberModal('${member.id}')">
                                    <i class="ri-edit-line"></i>
                                </button>
                                <button class="btn btn-sm btn-danger" onclick="deleteMember('${member.id}')">
                                    <i class="ri-delete-bin-line"></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                `).join('');
        }

        // ==================== ROLES ====================
        function openRoleModal(roleId = null) {
            const modal = document.getElementById('roleModal');
            const form = document.getElementById('roleForm');
            form.reset();

            if (roleId) {
                const role = appData.roles.find(r => r.id === roleId);
                if (role) {
                    document.getElementById('roleModalTitle').textContent = 'Redigera roll';
                    document.getElementById('roleId').value = role.id;
                    document.getElementById('roleName').value = role.name;
                    document.getElementById('roleDescription').value = role.description || '';
                }
            } else {
                document.getElementById('roleModalTitle').textContent = 'Ny roll';
                document.getElementById('roleId').value = '';
            }

            modal.classList.add('active');
        }

        function closeRoleModal() {
            document.getElementById('roleModal').classList.remove('active');
        }

        function saveRole(e) {
            e.preventDefault();

            const id = document.getElementById('roleId').value || generateId();
            const roleData = {
                id,
                name: document.getElementById('roleName').value,
                description: document.getElementById('roleDescription').value
            };

            const existingIndex = appData.roles.findIndex(r => r.id === id);
            if (existingIndex >= 0) {
                appData.roles[existingIndex] = roleData;
            } else {
                appData.roles.push(roleData);
            }

            saveData(appData);
            renderRoles();
            closeRoleModal();
        }

        function deleteRole(id) {
            const usedInShifts = appData.shifts.some(s => s.roleId === id);
            if (usedInShifts) {
                alert('Denna roll anvÃ¤nds i ett eller flera pass och kan inte tas bort.');
                return;
            }
            if (confirm('Ã„r du sÃ¤ker pÃ¥ att du vill ta bort denna roll?')) {
                appData.roles = appData.roles.filter(r => r.id !== id);
                saveData(appData);
                renderRoles();
            }
        }

        function renderRoles() {
            const tbody = document.getElementById('rolesList');
            
            if (appData.roles.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="3">
                            <div class="empty-state">
                                <i class="ri-price-tag-3-line"></i>
                                <p>Inga roller skapade Ã¤nnu</p>
                                <button class="btn btn-primary" onclick="openRoleModal()">
                                    <i class="ri-add-line"></i> Skapa din fÃ¶rsta roll
                                </button>
                            </div>
                        </td>
                    </tr>
                `;
                return;
            }

            tbody.innerHTML = appData.roles.map(role => `
                <tr>
                    <td><strong>${role.name}</strong></td>
                    <td>${role.description || '-'}</td>
                    <td>
                        <div class="action-buttons">
                            <button class="btn btn-sm btn-secondary" onclick="openRoleModal('${role.id}')">
                                <i class="ri-edit-line"></i>
                            </button>
                            <button class="btn btn-sm btn-danger" onclick="deleteRole('${role.id}')">
                                <i class="ri-delete-bin-line"></i>
                            </button>
                        </div>
                    </td>
                </tr>
            `).join('');
        }

        // ==================== SCHEDULE VIEW ====================
        let currentScheduleView = 'timeline';

        function setScheduleView(view) {
            currentScheduleView = view;
            document.querySelectorAll('.view-btn').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.view === view);
            });
            renderSchedule();
        }

        function populateScheduleFilters() {
            const eventFilter = document.getElementById('scheduleEventFilter');
            const memberFilter = document.getElementById('scheduleMemberFilter');

            eventFilter.innerHTML = '<option value="">VÃ¤lj evenemang fÃ¶r tidslinje</option>' +
                appData.events
                    .sort((a, b) => new Date(a.date) - new Date(b.date))
                    .map(e => `<option value="${e.id}">${e.name} (${formatDate(e.date)})</option>`)
                    .join('');

            memberFilter.innerHTML = '<option value="">Alla medlemmar</option>' +
                appData.members
                    .sort((a, b) => a.name.localeCompare(b.name, 'sv'))
                    .map(m => `<option value="${m.id}">${m.name}</option>`)
                    .join('');

            // Auto-select first event if available
            if (appData.events.length > 0 && !eventFilter.value) {
                eventFilter.value = appData.events[0].id;
            }
        }

        function renderSchedule() {
            if (currentScheduleView === 'timeline') {
                renderTimelineView();
            } else {
                renderListView();
            }
        }

        function renderTimelineView() {
            const container = document.getElementById('scheduleView');
            const eventFilter = document.getElementById('scheduleEventFilter').value;

            if (!eventFilter) {
                container.innerHTML = `
                    <div class="empty-state">
                        <i class="ri-calendar-todo-line"></i>
                        <p>VÃ¤lj ett evenemang ovan fÃ¶r att visa tidslinjen</p>
                    </div>
                `;
                return;
            }

            const event = appData.events.find(e => e.id === eventFilter);
            const eventShifts = appData.shifts.filter(s => s.eventId === eventFilter);

            if (eventShifts.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <i class="ri-calendar-todo-line"></i>
                        <p>Inga pass fÃ¶r detta evenemang</p>
                    </div>
                `;
                return;
            }

            // Get unique time slots
            const timeSlots = [...new Set(eventShifts.map(s => s.startTime))]
                .sort((a, b) => a.localeCompare(b));

            // Get roles used in this event
            const roleIds = [...new Set(eventShifts.map(s => s.roleId))];
            const roles = roleIds.map(id => appData.roles.find(r => r.id === id)).filter(r => r);

            // Calculate summary stats
            const totalSlots = eventShifts.reduce((sum, s) => sum + (s.count || 1), 0);
            const assignedSlots = eventShifts.reduce((sum, s) => sum + (s.assignedMembers?.length || 0), 0);
            const unassignedSlots = totalSlots - assignedSlots;

            // Build the grid - calculate column widths based on number of time slots
            const numCols = timeSlots.length;
            const colWidth = numCols <= 6 ? '1fr' : numCols <= 10 ? 'minmax(80px, 1fr)' : 'minmax(60px, 1fr)';
            const gridColumns = `minmax(80px, 100px) repeat(${numCols}, ${colWidth})`;

            let html = `
                <!-- Print Header -->
                <div class="print-only" style="margin-bottom: 20px; padding-bottom: 16px; border-bottom: 3px solid #333;">
                    <h1 style="font-size: 18pt; margin-bottom: 4px;">Bemanningsschema: ${event.name}</h1>
                    <p style="font-size: 11pt; color: #666;">${formatDateLong(event.date)}${event.location ? ' â€¢ ' + event.location : ''}</p>
                </div>

                <!-- Summary Cards -->
                <div class="summary-grid">
                    <div class="summary-card">
                        <h4>Evenemang</h4>
                        <div class="value" style="font-size: 1.1rem;">${event.name}</div>
                        <div style="color: var(--text-muted); font-size: 0.85rem;">${formatDateLong(event.date)}</div>
                    </div>
                    <div class="summary-card" style="border-left-color: var(--success);">
                        <h4>Bemannade</h4>
                        <div class="value" style="color: var(--success);">${assignedSlots}</div>
                    </div>
                    <div class="summary-card" style="border-left-color: ${unassignedSlots > 0 ? 'var(--warning)' : 'var(--success)'};">
                        <h4>Saknas</h4>
                        <div class="value" style="color: ${unassignedSlots > 0 ? 'var(--warning)' : 'var(--success)'};">${unassignedSlots}</div>
                    </div>
                    <div class="summary-card" style="border-left-color: var(--secondary);">
                        <h4>Totalt</h4>
                        <div class="value">${totalSlots}</div>
                    </div>
                </div>

                <!-- Legend -->
                <div class="timeline-legend">
                    <div class="legend-item">
                        <span class="timeline-slot assigned" style="padding: 4px 8px;"><i class="ri-check-line"></i> Bemannad</span>
                    </div>
                    <div class="legend-item">
                        <span class="timeline-slot unassigned" style="padding: 4px 8px;"><i class="ri-alert-line"></i> Saknas</span>
                    </div>
                    ${roles.map((role, i) => `
                        <div class="legend-item">
                            <span class="role-dot role-dot-${i % 7}"></span>
                            ${role.name}
                        </div>
                    `).join('')}
                </div>

                <!-- Timeline Grid -->
                <div class="timeline-container">
                    <div class="timeline-grid" style="grid-template-columns: ${gridColumns};">
                        <!-- Header Row -->
                        <div class="timeline-header">
                            <div class="timeline-header-cell role-header">Roll</div>
                            ${timeSlots.map(time => {
                                const shift = eventShifts.find(s => s.startTime === time);
                                return `<div class="timeline-header-cell">${time} - ${shift?.endTime || ''}</div>`;
                            }).join('')}
                        </div>
            `;

            // Render each role row
            roles.forEach((role, roleIndex) => {
                html += `<div class="timeline-row">`;
                html += `<div class="timeline-role-cell role-color-${roleIndex % 7}">
                    <span class="role-dot role-dot-${roleIndex % 7}"></span>
                    ${role.name}
                </div>`;

                timeSlots.forEach(time => {
                    const shift = eventShifts.find(s => s.startTime === time && s.roleId === role.id);
                    
                    if (!shift) {
                        html += `<div class="timeline-cell" style="background: #f1f5f9;"></div>`;
                    } else {
                        const needed = shift.count || 1;
                        const assigned = shift.assignedMembers || [];
                        const members = assigned.map(id => appData.members.find(m => m.id === id)).filter(m => m);
                        const missing = needed - members.length;

                        html += `<div class="timeline-cell ${missing > 0 ? 'unassigned' : ''}">`;
                        
                        // Show assigned members
                        members.forEach(member => {
                            html += `<div class="timeline-slot assigned">
                                <i class="ri-user-line"></i>
                                ${member.name.split(' ')[0]}
                            </div>`;
                        });

                        // Show missing slots
                        for (let i = 0; i < missing; i++) {
                            html += `<div class="timeline-slot unassigned">
                                <i class="ri-user-add-line"></i>
                                Saknas
                            </div>`;
                        }

                        html += `</div>`;
                    }
                });

                html += `</div>`;
            });

            html += `
                    </div>
                </div>
            `;

            // Add member timeline view
            html += renderMemberTimeline(eventFilter, timeSlots);

            container.innerHTML = html;
        }

        function renderMemberTimeline(eventId, timeSlots) {
            const eventShifts = appData.shifts.filter(s => s.eventId === eventId);
            
            // Build member assignments
            const memberAssignments = {};
            eventShifts.forEach(shift => {
                (shift.assignedMembers || []).forEach(memberId => {
                    if (!memberAssignments[memberId]) {
                        memberAssignments[memberId] = [];
                    }
                    memberAssignments[memberId].push(shift);
                });
            });

            if (Object.keys(memberAssignments).length === 0) {
                return '';
            }

            const roleColors = ['#3b82f6', '#22c55e', '#f59e0b', '#ef4444', '#8b5cf6', '#ec4899', '#06b6d4'];

            let html = `
                <div class="member-timeline">
                    <h3 style="margin-bottom: 16px;"><i class="ri-team-line"></i> Ã–versikt per person</h3>
            `;

            Object.entries(memberAssignments)
                .map(([memberId, shifts]) => ({
                    member: appData.members.find(m => m.id === memberId),
                    shifts: shifts.sort((a, b) => a.startTime.localeCompare(b.startTime))
                }))
                .filter(item => item.member)
                .sort((a, b) => a.member.name.localeCompare(b.member.name, 'sv'))
                .forEach(item => {
                    html += `
                        <div class="member-row">
                            <div class="member-name">
                                <i class="ri-user-line"></i>
                                ${item.member.name}
                            </div>
                            <div class="member-shifts">
                    `;

                    item.shifts.forEach(shift => {
                        const role = appData.roles.find(r => r.id === shift.roleId);
                        const roleIndex = appData.roles.findIndex(r => r.id === shift.roleId);
                        const color = roleColors[roleIndex % 7];
                        
                        html += `
                            <div class="member-shift-block" style="background: ${color}20; border: 2px solid ${color}; color: ${color};">
                                <span class="time">${shift.startTime}-${shift.endTime}</span>
                                <span class="role">${role?.name || '?'}</span>
                            </div>
                        `;
                    });

                    html += `
                            </div>
                        </div>
                    `;
                });

            html += `</div>`;
            return html;
        }

        function renderListView() {
            const container = document.getElementById('scheduleView');
            const eventFilter = document.getElementById('scheduleEventFilter').value;
            const memberFilter = document.getElementById('scheduleMemberFilter').value;

            // Build schedule per person
            const scheduleByPerson = {};

            appData.shifts.forEach(shift => {
                if (eventFilter && shift.eventId !== eventFilter) return;

                const event = appData.events.find(e => e.id === shift.eventId);
                if (!event) return;

                (shift.assignedMembers || []).forEach(memberId => {
                    if (memberFilter && memberId !== memberFilter) return;

                    const member = appData.members.find(m => m.id === memberId);
                    if (!member) return;

                    if (!scheduleByPerson[memberId]) {
                        scheduleByPerson[memberId] = {
                            member,
                            shifts: []
                        };
                    }

                    const role = appData.roles.find(r => r.id === shift.roleId);
                    scheduleByPerson[memberId].shifts.push({
                        event,
                        shift,
                        role
                    });
                });
            });

            if (Object.keys(scheduleByPerson).length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <i class="ri-calendar-todo-line"></i>
                        <p>Inga tilldelade pass att visa</p>
                    </div>
                `;
                return;
            }

            // Sort by person name
            const sortedPersons = Object.values(scheduleByPerson)
                .sort((a, b) => a.member.name.localeCompare(b.member.name, 'sv'));

            // Get event info for print header
            const event = eventFilter ? appData.events.find(e => e.id === eventFilter) : null;
            const printHeader = `
                <div class="print-only" style="margin-bottom: 20px; padding-bottom: 16px; border-bottom: 3px solid #333;">
                    <h1 style="font-size: 18pt; margin-bottom: 4px;">Bemanningsschema${event ? ': ' + event.name : ''}</h1>
                    ${event ? `<p style="font-size: 11pt; color: #666;">${formatDateLong(event.date)}${event.location ? ' â€¢ ' + event.location : ''}</p>` : ''}
                </div>
            `;

            container.innerHTML = printHeader + sortedPersons.map(personData => {
                // Sort shifts by date and time
                personData.shifts.sort((a, b) => {
                    const dateCompare = new Date(a.event.date) - new Date(b.event.date);
                    if (dateCompare !== 0) return dateCompare;
                    return a.shift.startTime.localeCompare(b.shift.startTime);
                });

                return `
                    <div class="person-schedule">
                        <h3>
                            <i class="ri-user-line"></i> ${personData.member.name}
                            ${personData.member.phone ? `<span style="font-weight: normal; color: var(--text-muted);"> - ${personData.member.phone}</span>` : ''}
                        </h3>
                        ${personData.shifts.map(item => `
                            <div class="schedule-item">
                                <div class="schedule-event">${item.event.name}</div>
                                <div class="schedule-details">
                                    <i class="ri-calendar-line"></i> ${formatDate(item.event.date)}
                                    <span style="margin: 0 8px;">|</span>
                                    <i class="ri-time-line"></i> ${item.shift.startTime} - ${item.shift.endTime}
                                    <span style="margin: 0 8px;">|</span>
                                    <span class="role-tag">${item.role?.name || 'OkÃ¤nd roll'}</span>
                                    ${item.event.location ? `<span style="margin: 0 8px;">|</span><i class="ri-map-pin-line"></i> ${item.event.location}` : ''}
                                </div>
                                ${item.shift.notes ? `<div style="margin-top: 4px; font-style: italic; color: var(--text-muted);">${item.shift.notes}</div>` : ''}
                            </div>
                        `).join('')}
                    </div>
                `;
            }).join('');
        }

        // ==================== MESSAGES VIEW ====================
        function populateMessageFilters() {
            const eventFilter = document.getElementById('messageEventFilter');
            const filterGroup = eventFilter.closest('.filter-group');
            
            // Only show upcoming events (today or later)
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            
            const upcomingEvents = appData.events
                .filter(e => new Date(e.date) >= today)
                .sort((a, b) => new Date(a.date) - new Date(b.date));
            
            if (upcomingEvents.length === 0) {
                // No upcoming events
                eventFilter.innerHTML = '<option value="">Inga kommande evenemang</option>';
                eventFilter.style.display = 'block';
            } else if (upcomingEvents.length === 1) {
                // Only one event - auto-select and hide dropdown
                eventFilter.innerHTML = `<option value="${upcomingEvents[0].id}">${upcomingEvents[0].name} (${formatDate(upcomingEvents[0].date)})</option>`;
                eventFilter.value = upcomingEvents[0].id;
                eventFilter.style.display = 'none';
                // Show event name as text instead
                let eventLabel = filterGroup.querySelector('.auto-selected-event');
                if (!eventLabel) {
                    eventLabel = document.createElement('span');
                    eventLabel.className = 'auto-selected-event';
                    eventLabel.style.cssText = 'font-weight: 600; font-size: 1rem; color: var(--charcoal);';
                    filterGroup.insertBefore(eventLabel, eventFilter);
                }
                eventLabel.innerHTML = `<i class="ri-calendar-event-line" style="color: var(--primary);"></i> ${upcomingEvents[0].name}`;
                renderMessages();
            } else {
                // Multiple events - show dropdown
                eventFilter.style.display = 'block';
                eventFilter.innerHTML = '<option value="">VÃ¤lj evenemang</option>' +
                    upcomingEvents
                        .map(e => `<option value="${e.id}">${e.name} (${formatDate(e.date)})</option>`)
                        .join('');
                // Remove auto-selected label if exists
                const eventLabel = filterGroup.querySelector('.auto-selected-event');
                if (eventLabel) eventLabel.remove();
            }
        }

        function toggleMessageTemplate() {
            const editor = document.getElementById('messageTemplateEditor');
            const isHidden = editor.style.display === 'none';
            editor.style.display = isHidden ? 'block' : 'none';
            
            if (isHidden) {
                // Load current template
                const template = appData.messageTemplate || DEFAULT_MESSAGE_TEMPLATE;
                document.getElementById('messageTemplate').value = template;
            }
        }

        function saveMessageTemplate() {
            const template = document.getElementById('messageTemplate').value;
            appData.messageTemplate = template;
            saveData(appData);
            renderMessages();
            alert('Mallen har sparats!');
        }

        function resetMessageTemplate() {
            if (confirm('Vill du Ã¥terstÃ¤lla till standardmallen? Din nuvarande mall kommer att skrivas Ã¶ver.')) {
                document.getElementById('messageTemplate').value = DEFAULT_MESSAGE_TEMPLATE;
                appData.messageTemplate = DEFAULT_MESSAGE_TEMPLATE;
                saveData(appData);
                renderMessages();
            }
        }

        function renderMessages() {
            const container = document.getElementById('messagesView');
            const eventFilter = document.getElementById('messageEventFilter').value;

            if (!eventFilter) {
                container.innerHTML = `
                    <div class="empty-state">
                        <i class="ri-message-2-line"></i>
                        <p>VÃ¤lj ett evenemang fÃ¶r att generera meddelanden</p>
                    </div>
                `;
                return;
            }

            const event = appData.events.find(e => e.id === eventFilter);
            if (!event) return;

            const eventShifts = appData.shifts
                .filter(s => s.eventId === eventFilter)
                .sort((a, b) => a.startTime.localeCompare(b.startTime));

            if (eventShifts.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <i class="ri-message-2-line"></i>
                        <p>Inga pass fÃ¶r detta evenemang</p>
                    </div>
                `;
                return;
            }

            // Group shifts by member (one message per person)
            const memberShifts = {};
            
            eventShifts.forEach(shift => {
                (shift.assignedMembers || []).forEach(memberId => {
                    if (!memberShifts[memberId]) {
                        memberShifts[memberId] = [];
                    }
                    memberShifts[memberId].push(shift);
                });
            });

            // Check for unassigned shifts
            const unassignedShifts = eventShifts.filter(s => !s.assignedMembers || s.assignedMembers.length === 0);

            let html = '';

            // Show summary
            const assignedMemberCount = Object.keys(memberShifts).length;
            html += `
                <div style="margin-bottom: 20px; padding: 16px; background: var(--bg); border-radius: 8px;">
                    <strong>${assignedMemberCount} meddelanden</strong> att skicka
                    ${unassignedShifts.length > 0 ? `<span class="badge badge-warning" style="margin-left: 8px;">${unassignedShifts.length} obemannade pass</span>` : ''}
                </div>
            `;

            if (assignedMemberCount === 0) {
                html += `
                    <div class="empty-state">
                        <i class="ri-user-add-line"></i>
                        <p>Inga medlemmar tilldelade till detta evenemang</p>
                    </div>
                `;
                container.innerHTML = html;
                return;
            }

            // Generate message for each member
            Object.entries(memberShifts)
                .map(([memberId, shifts]) => ({
                    member: appData.members.find(m => m.id === memberId),
                    shifts: shifts.sort((a, b) => a.startTime.localeCompare(b.startTime))
                }))
                .filter(item => item.member)
                .sort((a, b) => a.member.name.localeCompare(b.member.name, 'sv'))
                .forEach(item => {
                    const messageText = generateMessageText(event, item.shifts, item.member);
                    
                    html += `
                        <div class="message-preview" style="margin-bottom: 16px;">
                            <h4 style="display: flex; align-items: center; gap: 10px; flex-wrap: wrap;">
                                <i class="ri-user-line"></i> ${item.member.name}
                                <span class="badge" style="background: rgba(232,93,4,0.2); color: var(--primary-light);">${item.shifts.length} pass</span>
                                ${item.member.phone ? `<span style="color: rgba(255,255,255,0.6); font-weight: normal; font-size: 0.8rem;"><i class="ri-phone-line"></i> ${item.member.phone}</span>` : ''}
                                ${item.member.email ? `<span style="color: rgba(255,255,255,0.6); font-weight: normal; font-size: 0.8rem;"><i class="ri-mail-line"></i> ${item.member.email}</span>` : ''}
                            </h4>
                            <div style="background: var(--cream); color: var(--text); padding: 16px; border-radius: var(--radius); margin-top: 12px; white-space: pre-wrap; font-size: 0.9rem; line-height: 1.6; border: 1px solid var(--border);">${escapeHtml(messageText)}</div>
                            <div style="margin-top: 8px; display: flex; gap: 8px; flex-wrap: wrap;">
                                <button class="btn btn-sm btn-secondary copy-btn" onclick="copyToClipboard(this, \`${escapeForJs(messageText)}\`)">
                                    <i class="ri-file-copy-line"></i> Kopiera
                                </button>
                                ${item.member.phone ? `
                                    <a href="https://wa.me/${formatPhoneForWhatsApp(item.member.phone)}?text=${encodeURIComponent(messageText)}" target="_blank" class="btn btn-sm btn-success">
                                        <i class="ri-whatsapp-line"></i> WhatsApp
                                    </a>
                                    <a href="sms:${item.member.phone}&body=${encodeURIComponent(messageText)}" class="btn btn-sm btn-secondary">
                                        <i class="ri-message-line"></i> SMS
                                    </a>
                                ` : ''}
                                ${item.member.email ? `
                                    <a href="mailto:${item.member.email}?subject=${encodeURIComponent('FunktionÃ¤rspass: ' + event.name)}&body=${encodeURIComponent(messageText)}" class="btn btn-sm btn-secondary">
                                        <i class="ri-mail-line"></i> E-post
                                    </a>
                                ` : ''}
                            </div>
                        </div>
                    `;
                });

            container.innerHTML = html;
        }

        function generateMessageText(event, shifts, member) {
            const template = appData.messageTemplate || DEFAULT_MESSAGE_TEMPLATE;
            const formattedDate = formatDateLong(event.date);
            
            // Build the member's shifts list
            const shiftsList = shifts.map(shift => {
                const role = appData.roles.find(r => r.id === shift.roleId);
                let line = `â° ${shift.startTime} - ${shift.endTime}  ðŸ·ï¸ ${role?.name || 'OkÃ¤nd'}`;
                if (shift.notes) {
                    line += `\n   ðŸ“ ${shift.notes}`;
                }
                return line;
            }).join('\n');

            // Build the full schedule with all members and phone numbers
            const allEventShifts = appData.shifts
                .filter(s => s.eventId === event.id)
                .sort((a, b) => a.startTime.localeCompare(b.startTime));
            
            const fullSchedule = allEventShifts.map(shift => {
                const role = appData.roles.find(r => r.id === shift.roleId);
                const assignedMembers = (shift.assignedMembers || [])
                    .map(id => appData.members.find(m => m.id === id))
                    .filter(m => m);
                
                if (assignedMembers.length === 0) {
                    return `${shift.startTime}-${shift.endTime} ${role?.name || '?'}: (ingen tilldelad)`;
                }
                
                const memberList = assignedMembers.map(m => {
                    const phone = m.phone ? ` ðŸ“ž${m.phone}` : '';
                    return `${m.name}${phone}`;
                }).join(', ');
                
                return `${shift.startTime}-${shift.endTime} ${role?.name || '?'}: ${memberList}`;
            }).join('\n\n');

            // Replace placeholders
            let message = template
                .replace(/{namn}/g, member.name)
                .replace(/{fÃ¶rnamn}/g, member.name.split(' ')[0])
                .replace(/{evenemang}/g, event.name)
                .replace(/{datum}/g, formattedDate)
                .replace(/{plats}/g, event.location || 'Ej angiven')
                .replace(/{pass_lista}/g, shiftsList)
                .replace(/{alla_pass}/g, fullSchedule);

            return message;
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function formatPhoneForWhatsApp(phone) {
            // Remove all non-digit characters except leading +
            let cleaned = phone.replace(/[^\d+]/g, '');
            
            // Remove leading + if present
            if (cleaned.startsWith('+')) {
                cleaned = cleaned.substring(1);
            }
            
            // If Swedish number starting with 0, replace with 46
            if (cleaned.startsWith('0')) {
                cleaned = '46' + cleaned.substring(1);
            }
            
            // If number doesn't have country code (less than 10 digits), assume Swedish
            if (cleaned.length <= 10 && !cleaned.startsWith('46')) {
                cleaned = '46' + cleaned;
            }
            
            return cleaned;
        }

        function escapeForJs(str) {
            return str.replace(/`/g, '\\`').replace(/\$/g, '\\$');
        }

        function copyToClipboard(btn, text) {
            navigator.clipboard.writeText(text).then(() => {
                const originalText = btn.innerHTML;
                btn.innerHTML = '<i class="ri-check-line"></i> Kopierat!';
                btn.classList.remove('btn-secondary');
                btn.classList.add('btn-success');
                setTimeout(() => {
                    btn.innerHTML = originalText;
                    btn.classList.remove('btn-success');
                    btn.classList.add('btn-secondary');
                }, 2000);
            });
        }

        // ==================== UTILITIES ====================
        function formatDate(dateStr) {
            const date = new Date(dateStr);
            return date.toLocaleDateString('sv-SE', {
                weekday: 'short',
                day: 'numeric',
                month: 'short'
            });
        }

        function formatDateLong(dateStr) {
            const date = new Date(dateStr);
            return date.toLocaleDateString('sv-SE', {
                weekday: 'long',
                day: 'numeric',
                month: 'long',
                year: 'numeric'
            });
        }

        function updateStats() {
            document.getElementById('statEvents').textContent = appData.events.length;
            document.getElementById('statShifts').textContent = appData.shifts.length;
            document.getElementById('statMembers').textContent = appData.members.length;
            
            const totalAssigned = appData.shifts.reduce((sum, s) => sum + (s.assignedMembers?.length || 0), 0);
            document.getElementById('statAssigned').textContent = totalAssigned;
        }

        // ==================== EXPORT / IMPORT ====================
        function openExportModal() {
            const modal = document.getElementById('exportModal');
            
            // Check all boxes by default
            document.getElementById('exportMembers').checked = true;
            document.getElementById('exportRoles').checked = true;
            document.getElementById('exportEvents').checked = true;
            document.getElementById('exportShifts').checked = true;
            document.getElementById('exportTemplate').checked = true;
            
            // Generate export data
            updateExportData();
            
            // Add event listeners
            document.querySelectorAll('#exportModal input[type="checkbox"]').forEach(cb => {
                cb.addEventListener('change', updateExportData);
            });
            
            modal.classList.add('active');
        }

        function closeExportModal() {
            document.getElementById('exportModal').classList.remove('active');
        }

        function updateExportData() {
            const exportObj = {
                _format: 'funktionarsplanering_v1',
                _exportDate: new Date().toISOString()
            };

            if (document.getElementById('exportMembers').checked) {
                exportObj.members = appData.members;
            }
            if (document.getElementById('exportRoles').checked) {
                exportObj.roles = appData.roles;
            }
            if (document.getElementById('exportEvents').checked) {
                exportObj.events = appData.events;
            }
            if (document.getElementById('exportShifts').checked) {
                exportObj.shifts = appData.shifts;
            }
            if (document.getElementById('exportTemplate').checked && appData.messageTemplate) {
                exportObj.messageTemplate = appData.messageTemplate;
            }

            const jsonStr = JSON.stringify(exportObj, null, 2);
            document.getElementById('exportData').value = jsonStr;
        }

        function copyExportData() {
            const data = document.getElementById('exportData').value;
            navigator.clipboard.writeText(data).then(() => {
                alert('Data kopierad till urklipp!\n\nDela den med nÃ¥gon annan eller spara som backup.');
            });
        }

        function downloadExportData() {
            const data = document.getElementById('exportData').value;
            const blob = new Blob([data], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `funktionarsplanering_${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        function openImportModal() {
            const modal = document.getElementById('importModal');
            document.getElementById('importData').value = '';
            document.getElementById('importFile').value = '';
            document.getElementById('importPreview').style.display = 'none';
            document.querySelector('input[name="importMode"][value="merge"]').checked = true;
            modal.classList.add('active');
        }

        function closeImportModal() {
            document.getElementById('importModal').classList.remove('active');
        }

        function loadImportFile(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                document.getElementById('importData').value = e.target.result;
                previewImport();
            };
            reader.readAsText(file);
        }

        function parseImportData() {
            const dataStr = document.getElementById('importData').value.trim();
            if (!dataStr) {
                return { error: 'Ingen data att importera' };
            }

            try {
                const data = JSON.parse(dataStr);
                
                // Validate format
                if (!data._format || !data._format.startsWith('funktionarsplanering')) {
                    return { error: 'Ogiltig dataformat. Se till att du klistrat in korrekt exporterad data.' };
                }

                return { data };
            } catch (e) {
                return { error: 'Kunde inte lÃ¤sa JSON-data. Kontrollera att formatet Ã¤r korrekt.' };
            }
        }

        function previewImport() {
            const result = parseImportData();
            const preview = document.getElementById('importPreview');
            const content = document.getElementById('importPreviewContent');

            if (result.error) {
                preview.style.display = 'block';
                content.innerHTML = `<span style="color: var(--danger);"><i class="ri-error-warning-line"></i> ${result.error}</span>`;
                return;
            }

            const data = result.data;
            let html = '<div style="margin-top: 8px;">';
            
            if (data.members) {
                html += `<span class="badge badge-primary" style="margin: 2px;">${data.members.length} medlemmar</span>`;
            }
            if (data.roles) {
                html += `<span class="badge badge-primary" style="margin: 2px;">${data.roles.length} roller</span>`;
            }
            if (data.events) {
                html += `<span class="badge badge-primary" style="margin: 2px;">${data.events.length} evenemang</span>`;
            }
            if (data.shifts) {
                html += `<span class="badge badge-primary" style="margin: 2px;">${data.shifts.length} pass</span>`;
            }
            if (data.messageTemplate) {
                html += `<span class="badge badge-primary" style="margin: 2px;">Meddelandemall</span>`;
            }
            
            if (data._exportDate) {
                html += `<div style="margin-top: 8px; font-size: 0.8rem; color: var(--text-muted);">Exporterad: ${formatDateLong(data._exportDate.split('T')[0])}</div>`;
            }

            html += '</div>';
            
            preview.style.display = 'block';
            content.innerHTML = html;
        }

        function executeImport() {
            const result = parseImportData();
            
            if (result.error) {
                alert(result.error);
                return;
            }

            const data = result.data;
            const mode = document.querySelector('input[name="importMode"]:checked').value;

            if (mode === 'replace') {
                if (!confirm('Detta kommer att RADERA all befintlig data och ersÃ¤tta med importerad data. Ã„r du sÃ¤ker?')) {
                    return;
                }
                
                // Replace all data
                if (data.members) appData.members = data.members;
                if (data.roles) appData.roles = data.roles;
                if (data.events) appData.events = data.events;
                if (data.shifts) appData.shifts = data.shifts;
                if (data.messageTemplate) appData.messageTemplate = data.messageTemplate;
                
            } else {
                // Merge mode - add new items, skip duplicates by id
                let stats = { members: 0, roles: 0, events: 0, shifts: 0 };
                
                if (data.members) {
                    data.members.forEach(member => {
                        // Check for duplicate by id or name
                        const exists = appData.members.some(m => m.id === member.id || m.name === member.name);
                        if (!exists) {
                            member.id = generateId(); // Generate new ID to avoid conflicts
                            appData.members.push(member);
                            stats.members++;
                        }
                    });
                }
                
                if (data.roles) {
                    data.roles.forEach(role => {
                        const exists = appData.roles.some(r => r.id === role.id || r.name === role.name);
                        if (!exists) {
                            role.id = generateId();
                            appData.roles.push(role);
                            stats.roles++;
                        }
                    });
                }
                
                if (data.events) {
                    // Create ID mapping for events and shifts
                    const eventIdMap = {};
                    data.events.forEach(event => {
                        const exists = appData.events.some(e => e.id === event.id);
                        const oldId = event.id;
                        event.id = generateId();
                        eventIdMap[oldId] = event.id;
                        appData.events.push(event);
                        stats.events++;
                    });
                    
                    // Import shifts with updated event IDs
                    if (data.shifts) {
                        data.shifts.forEach(shift => {
                            const newEventId = eventIdMap[shift.eventId];
                            if (newEventId) {
                                shift.id = generateId();
                                shift.eventId = newEventId;
                                // Map member IDs if possible, or clear assignments
                                if (shift.assignedMembers) {
                                    // Try to match members by name
                                    shift.assignedMembers = shift.assignedMembers.map(oldMemberId => {
                                        const importedMember = data.members?.find(m => m.id === oldMemberId);
                                        if (importedMember) {
                                            const localMember = appData.members.find(m => m.name === importedMember.name);
                                            return localMember?.id;
                                        }
                                        return null;
                                    }).filter(id => id);
                                }
                                // Map role IDs
                                if (shift.roleId) {
                                    const importedRole = data.roles?.find(r => r.id === shift.roleId);
                                    if (importedRole) {
                                        const localRole = appData.roles.find(r => r.name === importedRole.name);
                                        if (localRole) {
                                            shift.roleId = localRole.id;
                                        }
                                    }
                                }
                                appData.shifts.push(shift);
                                stats.shifts++;
                            }
                        });
                    }
                }
                
                if (data.messageTemplate && !appData.messageTemplate) {
                    appData.messageTemplate = data.messageTemplate;
                }

                alert(`Import klar!\n\nLade till:\n${stats.members} medlemmar\n${stats.roles} roller\n${stats.events} evenemang\n${stats.shifts} pass`);
            }

            saveData(appData);
            renderEvents();
            renderMembers();
            renderRoles();
            updateStats();
            closeImportModal();
            
            if (mode === 'replace') {
                alert('Import klar! All data har ersatts.');
            }
        }

        // Close modals on outside click
        document.querySelectorAll('.modal-overlay').forEach(overlay => {
            overlay.addEventListener('click', (e) => {
                if (e.target === overlay) {
                    overlay.classList.remove('active');
                }
            });
        });

        // Close modals on Escape key
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                document.querySelectorAll('.modal-overlay.active').forEach(modal => {
                    modal.classList.remove('active');
                });
            }
        });

        // ==================== TUTORIAL ====================
        const TUTORIAL_SHOWN_KEY = 'funktionarsplanering_tutorial_shown';

        function showTutorial() {
            document.getElementById('tutorialModal').classList.add('active');
            showDeviceInstructions();
        }

        function showDeviceInstructions() {
            const ua = navigator.userAgent || navigator.vendor || window.opera;
            
            // Hide all first
            document.getElementById('ios-instructions').style.display = 'none';
            document.getElementById('android-instructions').style.display = 'none';
            document.getElementById('desktop-instructions').style.display = 'none';
            
            // Detect device and show relevant instructions
            if (/iPad|iPhone|iPod/.test(ua) && !window.MSStream) {
                document.getElementById('ios-instructions').style.display = 'block';
            } else if (/android/i.test(ua)) {
                document.getElementById('android-instructions').style.display = 'block';
            } else {
                document.getElementById('desktop-instructions').style.display = 'block';
            }
        }

        function closeTutorial() {
            document.getElementById('tutorialModal').classList.remove('active');
            // Mark as shown
            localStorage.setItem(TUTORIAL_SHOWN_KEY, 'true');
        }

        function openTutorialAgain() {
            // This is called when user clicks "Don't show again"
            // Tutorial is already marked as shown in closeTutorial
        }

        function checkFirstVisit() {
            const tutorialShown = localStorage.getItem(TUTORIAL_SHOWN_KEY);
            if (!tutorialShown) {
                // First visit - show tutorial after a short delay
                setTimeout(() => {
                    showTutorial();
                }, 500);
            }
        }

        // ==================== INITIALIZATION ====================
        function init() {
            renderEvents();
            renderMembers();
            renderRoles();
            updateStats();
            checkFirstVisit();
        }

        init();
    </script>
</body>
</html>
